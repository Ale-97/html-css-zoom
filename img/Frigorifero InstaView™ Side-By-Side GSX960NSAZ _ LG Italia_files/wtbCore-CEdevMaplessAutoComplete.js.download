// Google Map API Standard Code
var map = undefined;
var markers = [];
var markerCluster;

var mapLoaded = false;
var variantDropdownLoaded = false;

// Set up for directions
var directionsStore = {};
var directionsUpdate = false;

var directionsDisplay = null;
var directionsService = null;
//

var geocoder;
var autocomplete;
var directionsAutocomplete;

var markers = new Array();
var distancenode = '';
var distancecode = 1;
var themiles = '';
var thekm = '';
var arr = new Array();
var d = new Date();
var totalrec = 0;
var default_distance = 100;
var default_location = "";

var productModels = [];
var productLabels = {};
var productSizes  = {};
var productRetailers = [];

var onlineRetailerHTML = [];

var retailerNumber = 0;

var onlineData = {};
var localData = {};

var localResults = {};

var version = 'latest';

/* ==== OnDemand Settings ==== */
var onDemandStores = [];
var onDemandStartTime;
var onDemandCallTimings = [0,3,8,15];

var onDemandAvailabilityUrl = '';

/* AvailabilityStatus */
var ODCallForAvailability = "CallForAvailability";
var ODAssumeAvailability = 1;
var ODAvailable = "Available";
var ODUnavailable = "NotAvailable";
var ODNotFound = 4;

/* OnDemandStatus */
var ODSUnknown = 0;
var ODSProcessing = "Processing";
var ODSComplete = "Complete";
var ODSFailed = "Error";

var onlineContainer = "onlineList";
var onlineRetailerContainer = "retailers-online";


var widgetConfig = {};

var trackEvents = true;

var model = "" ;
var profileId = 0;
var lang = "";

var guidParam = '';

var env = "prod";

var CaProductId = "";

var distanceUnits = "Miles";
var maxRange = 250;

var show12Hour = true;

var initialSearch = true;

var multiModel = false;
var lastMultiModelProduct = false;

var userAgent = navigator.userAgent;
var referrerUrl = document.referrer;

var isMobile = false; //initiate as false
// device detection
if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent) 
    || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))) { 
    isMobile = true;
}

var postCode = "";
var tag = "brandsite";

var currRange = 5;
var geo = {};

var currentStore = {};

var impressionEvent = {};
var widgetImpressionGuid;
var userTrackingGuid;

var authorizationToken = 'Z58QH8nvuxDQlHRDCC7M4fQtLZ4W+uKP+hd8WiMSPffIqQACkhKHckB+0NFCDuFsQ6P0YfUMVN8BTDRkW8xDCy9jG+rgsXsoYUae2wSy1Lg=';
var petsOAuth = "https://locations.where-to-buy.co/api/token/pets?profileId={0}";
var configUrl = "../config/{0}/{1}-config.json";
var petsCall  = "https://pets.channeladvisor.com/api/v1/event";
var pcatOffersCall = "https://productcatalog.channeladvisor.com/api/v1/offers/models/{0}?maxLocationsPerRetailer=25&maxResultsPerRetailer=25&IncludeVariations=TRUE";

var productImage = "";
var productDescription = "";

var startLatitude = 40.1451;
var startLongitude = -99.6680;
var startZoom = 3;

var region = 'us';

var currPlace = '';
var currPlaceDetails = undefined;

var customerLocation = '';
var customerPlace;

var attempt = 0;
var inProgress = false;

var placeChanged = false;

var searchFormTemplate = 
'<form class="map-search form-inline">' +
 	'<div id="searchBoxParent" class="input-group">' +
    	'<input id="searchLocation" type="text" onfocus="this.value = \'\';"' +
            'class="form-control" placeholder="Search Locations">' +
        '<div class="input-group-append">' +
            '<i class="material-icons" id="search-icon">' +
                'search' +
            '</i>' +
        '</div>' +
        '<select class="distance form-control" name="rangeSelect" id="rangeSelect">' +
        '</select>' +
    '</div>' +
'</form>';
/*
var buyOnlineTemplate =
'<div id="buy-online-retailer-block" class="row retailer-block align-items-center">'+
	'<div class="logo">' +
		'<img class="model-logo" src="{wtb_logo_url}" alt="{wtb_display_name}">' +
	'</div>' +
    '{wtb_onlineStockDetails}' +	
			'{wtb_add_to_cart}' +
	'<div class="buy" >' +
		'<span id="{wtb_display_name}BuyNow">' +
			'<a href="{store_deeplink_url}" target="_blank" class="btn btn-buynow " aria-label="Buy Now from {wtb_display_name}">' +
				'<i class="material-icons valign-center">open_in_new</i>' +
				'{wtb_buybuttontext}' +
			'</a>' +
		'</span>' +
	'</div>' +		
	'</div>';
*/

var buyOnlineTemplate =
'<div  class="retailers-online">'+
  '<div id="buy-online-retailer-block" class="row retailer-block {wtb_display_name} {wtb_stock} align-items-center">'+
	'<div class="logo">' +
		'<img class="model-logo" src="{wtb_logo_url}" alt="{wtb_display_name}">' +
	'</div>' +
    '{wtb_onlineStockDetails}' +	
	'{wtb_onlinePromotions}' +
	'<div class="nearby">' +
		'{wtb_onlineCheckNearby}' +
	'</div>' +
	'<div class="buy" >' +
		'{wtb_onlineBuyNow}' +
		'{wtb_onlineAddToCart}' +
	'</div>' +
  '</div>' +
'</div>';

var buyOnlineDescriptiveTemplate =
	'<div class="retailer-block {wtb_display_name} {wtb_stock}">'+
		'<div class="logo">' +
			'<a target="_blank" href="{store_deeplink_url}">' +
				'<img src="{wtb_logo_url}" alt="{wtb_display_name}">' +
			'</a>' +
   		'</div>' +
		'<div class="productname">' +
			'<p>{wtb_productname}</p>' +
		'</div>'+
		'<div class="productsize">' +
			'<p>{wtb_productsize}</p>' +
		'</div>'+
		'<div class="buy">' +
			'<a class="btn btn-{wtb_stock}" target="_blank" href="{store_deeplink_url}">{wtb_buybuttontext}</a>' +
		'</div>'+
	'</div>';

var buyOnlineSimpleTemplate =
	'<div class="retailer-block {wtb_display_name} {wtb_stock}">'+
		'<div class="logo">' +
			'<a target="_blank" href="{store_deeplink_url}">' +
				'<img src="{wtb_logo_url}" alt="{wtb_display_name}">' +
			'</a>' +
   		'</div>' +
		'<div class="price">' +
			'<a href="{store_deeplink_url}" target="_blank">{wtb_onlinePrice}</a>' +
		'</div>'+
		'<div class="stock">' +
			'<p>{wtb_stock}</p>' +
		'</div>'+
		'<div class="buy">' +
			'<a class="btn btn-{wtb_stock}" target="_blank" href="{store_deeplink_url}">{wtb_buybuttontext}</a>' +
		'</div>'+
	'</div>';

var buyLocalTemplate =
    '<div id="retailer_{wtb_retailerNameAndLocation}" class="retailer-block {wtb_attributeClass}" >' +
		'<div class="distance">' +
			'<div class="box" >' +
			'<div class="pin">'+
			'<i class="fa fa-map-marker" aria-hidden="true"></i>'+
				'<span id="{wtb_retailerNameAndLocation}_stock_pin" class="badge {wtb_titleTrim}_pin pin-no">' +
								
					'{wtb_counter}' +
				'</span></div>' +
				'<p>{wtb_distance} {wtb_distanceUnits}</p>' +
			'</div>' +
    	'</div>' +

		'<div class="details">' +
			'<img class="storeLogo" src="{wtb_logo}"/>' +
			'<h3 class="title"><span class="counter">{wtb_counter} </span>{wtb_retailerName}</h3>' +
			'<p class="address">' +
				'{wtb_streetline1}, {wtb_city}, {wtb_state}, {wtb_postcode}' +
			'</p>' +
			'<p class="phone">' +
				'<a href="tel:{wtb_phone}">{wtb_formatted_phone}</a>' +
			'</p>' +
			'<p class="directions">' +
				'<a href="{wtb_directions}" target="_blank" aria-label="Get Directions to {wtb_index} {wtb_title}">' +
					'{wtb_directionsLabel}' +
				'</a>' +
			'</p>' +			
		'</div>' +

		'<div class="options">' +
			'<div class="stock {wtb_stockType}" id="{wtb_retailerNameAndLocation}_stock">' +
				'<p class="price" >{wtb_onlinePrice}<br /></p>' +				
				'{wtb_statusDirect}' +
				'{wtb_statusOnDemand}' +
			'</div>' +
			'<p class="clickandcollect">' +
				'{wtb_clickandcollect}' +
			'</p>' +
			'<p class="hours">' +
				'{wtb_hours}' +
			'</p>' +	
			'{wtb_LocalPromotions}' +		
			'{wtb_BuyOnline}' +
		'</div>' +
    '</div>';

var buyLocalFullTemplate = 
	'<div class="row retailer-block no-gutters" >' +
		'<div class="col-sm-2 d-none d-sm-block">' +
			'<div class="box" >' + 
				'<span id="{wtb_retailerName}_stock_pin" class="badge {wtb_titleTrim}_pin">' +
				'<i class="material-icons">place</i>'+
					'{wtb_counter}' +
				'</span><br/>' +
			'</div>' +
		'</div>' +
		'<div class="col-6 details">' +
			'<h5 class="title" >' + 
				'{wtb_retailerName}' + 
			'</h5>' +
			'<p class="address">' +
				'{wtb_streetline1}, {wtb_city}<br />{wtb_state}, {wtb_postcode}' +
			'</p>' +
				'{wtb_phoneDisplay}' +
		'</div>' +
		'<div class="col-6 col-sm-4 options">' +
			'<div class="class="btn btn-showOnMap "" >' +
				'<b>Show On Map</b>' +
			'</div>' +
			'<div class="distance" id="{wtb_retailerName}_stock">' +
				'<b>{wtb_distance} mi</b>' +
			'</div>' +
			'<p class="directions">' +
				'<a href="{wtb_directions}" target="_blank" aria-label="Get Directions to {wtb_index} {wtb_title}">' + 
					'<i class="material-icons valign-center">' +
						'directions_car' +
					'</i>' +
					'<b>Directions</b>' +
				'</a>' +
			'</p>' +
		'</div>' +
	'</div>';

var featureCollapseTemplate = 
	'<div class="collapse" id="wtb-collapse" aria-expanded="false">' +
    	'<div class="card card-body">' +
			'{wtb_collapseContents}' +
        '</div>' +
    '</div>' +
  	'<a role="button" class="collapsed btn btn-collapse" data-toggle="collapse" href="#wtb-collapse" aria-expanded="false" aria-controls="wtb-collapse">' +
    	'{wtb_collapseText}' +
	'</a>';

cachesearch = '';


$(document).ready(function(){

	// Build up config
	model = GetURLParameter("model");
	profileId = GetURLParameter("pid");

	version = GetURLParameter("version");

	guidParam = GetURLParameter("guid");

	getProfileConfig();
});

function initWidget() {


	postPetsEvent('WidgetImpression');

	setEnvironment();

    getProfileCSS();
    
	setConfiguredCSS();

	addExternalJS();

	addProfileLogo();

	processExtraParams();

	showHideParts();

	customiseTextEntries();

	getOfferDetails();

	addExternalPixels();

	addEventHandlers();

	$('.nav-tabs a[href="#offline"]').click(function(){

		//console.log("Caught navTab click: " + widgetConfig.lateLoadMap + "|" + mapLoaded);

		if ( widgetConfig.lateLoadMap && !mapLoaded )
		{
			$('.wtb-local').show();
			$('#localSplashCover').hide();

			initMap();
			//addGoogleMapsJS();
		}
	});
};

function googleLibraryCallback() {

	initialiseAutoComplete();
	
	if ( !widgetConfig.useLateMapView ) {
		initMap();
	}
};

//**Map 
function initMap() {

	console.log('Running initMap');

	mapLoaded = true;

	var mapOptions = {
	  center: {lat: widgetConfig.startLatitude, lng: widgetConfig.startLongitude},
	  zoom: widgetConfig.startZoom
	}

	if ( widgetConfig.showMapControls != undefined && widgetConfig.showMapControls != null)
	{
		if ( !widgetConfig.showMapControls )
		{
			mapOptions.disableDefaultUI = true;
		}
	}
	else
	{
		mapOptions.disableDefaultUI = true;
	}

	if ( widgetConfig.zoomControls != undefined && widgetConfig.zoomControls != null && widgetConfig.zoomControls != '' )
	{			
		mapOptions.zoomControl = true;

		if ( widgetConfig.zoomControls == "TOP_RIGHT" )
		{
			mapOptions.zoomControlOptions = { position: google.maps.ControlPosition.TOP_RIGHT }
		}
		else if ( widgetConfig.zoomControls == "TOP_LEFT" )
		{
			mapOptions.zoomControlOptions = { position: google.maps.ControlPosition.TOP_LEFT }
		}
		else if ( widgetConfig.zoomControls == "RIGHT_BOTTOM" )
		{
			mapOptions.zoomControlOptions = { position: google.maps.ControlPosition.RIGHT_BOTTOM }
		}
	}

	map = new google.maps.Map(document.getElementById('map'), mapOptions);

	// initialise for directions if needed
	if ( widgetConfig.mapDirections != undefined && widgetConfig.mapDirections != null && widgetConfig.mapDirections )
	{
		directionsDisplay = new google.maps.DirectionsRenderer;
		directionsService = new google.maps.DirectionsService;

		var directionsInput = document.getElementById('startInput');

		directionsAutocomplete = new google.maps.places.Autocomplete(directionsInput,
						{		
        					componentRestrictions: {country: widgetConfig.region}
    					});

		// Set the data fields to return when the user selects a place.
		directionsAutocomplete.setFields(
			['address_components', 'geometry', 'icon', 'name']);

		directionsAutocomplete.addListener('place_changed', function() {
			if ( !inProgress ) generateDirections();
		});
	}

	if ( widgetConfig.getCustomerLocation != undefined && widgetConfig.getCustomerLocation != null && widgetConfig.getCustomerLocation )
	{
		console.log('Calling getCustomerLocation - 454');
		getCustomerLocation();	
	}
}

function initialiseAutoComplete ()
{
	console.log('reached initialiseAutoComplete');

	var textInput = document.getElementById('searchLocation');
	var searchInput = document.getElementById('search-icon');

	selectFirstOnEnter(textInput);
	
	$('#rangeSelect').change(function(){

		var firstResult = $(".pac-container .pac-item:first").text();
        var searchInputBox = $("#searchBoxParent > input").val();

        if ( firstResult != "" ||  searchInputBox != "" )
			place_changed();
	});

	var configWithoutRegions = { componentRestrictions: {country: widgetConfig.region} };
	var configWithRegions = { types: ['(regions)'], componentRestrictions: {country: widgetConfig.region} };

	var autoCompleteConfig = configWithoutRegions;

	if ( widgetConfig.autoCompleteRegions != undefined && widgetConfig.autoCompleteRegions != null && 
		 widgetConfig.autoCompleteRegions == true )
		autoCompleteConfig = configWithRegions;

	autocomplete = new google.maps.places.Autocomplete(textInput, autoCompleteConfig);

	// Set the data fields to return when the user selects a place.
	autocomplete.setFields(
		['address_components', 'geometry', 'icon', 'name']);

	autocomplete.addListener('place_changed', function() {
		console.log("AutoComplete listener - place_changed : " + inProgress);
		place_changed();
	});
}

function initialiseMap (currLat, currLong) 
{	
	var zoomLevel = 12;

	if ( currRange == 50 )
	{
		zoomLevel = 9;
	}
	else if ( currRange == 20 )
	{
		zoomLevel = 10;
	}
	else if ( currRange == 10 )
	{
		zoomLevel = 11;
	}

	if ( currLat == "" || currLong == "" ) {
		currLat = widgetConfig.startLatitude;
		currLong = widgetConfig.startLongitude;
		zoomLevel = widgetConfig.startZoom;
	}
	
	if ( map != undefined ) 
	{
		map.setZoom(zoomLevel);
		map.setCenter(new google.maps.LatLng( currLat,  currLong ));
		map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
	
		var image = new google.maps.MarkerImage(
			'img/image.png',
			new google.maps.Size(34,46),
			new google.maps.Point(0,0),
			new google.maps.Point(17,46)
		);

		var shadow = new google.maps.MarkerImage(
			'img/shadow.png',
			new google.maps.Size(60,46),
			new google.maps.Point(0,0),
			new google.maps.Point(17,46)
		);
		  
		// clear all markers
		jQuery.each(markers,function(k,v){
			v.setMap(null);
		});	
	}

	// clear list
	$('#localList').empty();
};

function getCustomerLocation () {
	navigator.geolocation.getCurrentPosition(
        function (position) {

        	if ( widgetConfig.useLateMapView != undefined && !widgetConfig.useLateMapView ) {
        		//GET USER CURRENT LOCATION                
	            var locCurrent = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
	            var geocoder = new google.maps.Geocoder();
	            geocoder.geocode({'latLng': locCurrent}, function (results, status) {
	            	var place = results[0];
	                customerLocation = place.formatted_address;
	                $("#searchLocation").val(customerLocation);

	                var address = '';
					  	if (place.address_components) {
							address = [
						  		(place.address_components[0] && place.address_components[0].short_name || ''),
						  		(place.address_components[1] && place.address_components[1].short_name || ''),
						  		(place.address_components[2] && place.address_components[2].short_name || '')
							].join(' ');
					  	}

					currPlace = address;
					customerPlace = place;
					currPlaceDetails = place;

					if ( widgetConfig.autoLocalSearch )
					{
						getOfferDetails();
					}
	            });

				map.setCenter(locCurrent);
				map.setZoom(10);	
        	} else {
        		widgetConfig.startLatitude = position.coords.latitude;
        		widgetConfig.startLongitude = position.coords.longitude;

        		console.log('getCustomerLocation: ' + widgetConfig.startLatitude, widgetConfig.startLongitude);
        		/*
        		// tmp for GP testing
        		widgetConfig.startLatitude = 40.6971478;
        		widgetConfig.startLongitude = -74.2605513;
				*/
				if ( widgetConfig.autoLocalSearch )
				{
					getOfferDetails();
				}
        	}
            
        }, defaultGeo()
    );
};

function defaultGeo () {
	if ( widgetConfig.useLateMapView != undefined && !widgetConfig.useLateMapView ) {
		map.setCenter(new google.maps.LatLng( widgetConfig.startLatitude,  widgetConfig.startLongitude));
		map.setZoom(widgetConfig.startZoom);
	}
};

function selectFirstOnEnter(input){
	// store the original event binding function
	var _addEventListener = (input.addEventListener) ? input.addEventListener : input.attachEvent;

	// Simulate a 'down arrow' keypress on hitting 'return' when no pac suggestion is selected, and then trigger the original listener.
	function addEventListenerWrapper(type, listener) {

		if (type == "keydown") { 
	  		var orig_listener = listener;
	  		listener = function (event) {

				//console.log('Caught event listener: ', event);

	  			var suggestion_selected = $(".pac-item-selected").length > 0;

	  			//console.log("Suggestion Count: " + suggestionCount);
	  			
	  			if (event.which == 13 && !suggestion_selected) {
		        	event.preventDefault();
	    			var simulated_downarrow = $.Event("keydown", { keyCode:40, which:40 });
	          		orig_listener.apply(input, [simulated_downarrow]);
	    		} else if (event.which == 13) {
	        		event.preventDefault();	
	    		}
	    		orig_listener.apply(input, [event]);
			};
		}

		// add the modified listener
		_addEventListener.apply(input, [type, listener]);
	}

	if (input.addEventListener) {
		input.addEventListener = addEventListenerWrapper;
	} else if (input.attachEvent) {
		    input.attachEvent = addEventListenerWrapper;
	}
} 

function place_changed() {

	if ( inProgress ) return;
	//console.log("place_changed inProgress - true");
	inProgress = true;

	placeChanged = true;

	// adjust for late loading
	widgetConfig.useLateMapView = false;

	var firstResult = $(".pac-container .pac-item:first").text();
    var searchInputBox = $("#searchBoxParent > input").val();
	
    var lookupAddress = firstResult;

    if ( firstResult == "" ) lookupAddress = searchInputBox;

  	var place = autocomplete.getPlace();

  	var placeAddr = '';

  	if ( place != undefined && place.address_components != undefined ) {
  		placeAddr = place.address_components[0].short_name.toLowerCase();
  	}

    //console.log('place_changed: ' + firstResult + "|" + searchInputBox + "|" + placeAddr);

    if ( place == undefined || place.geometry == undefined )
    {
    	try {
    		//console.log('Caught - no place selected - triggering keydown move');
	    	var input = document.getElementById('searchLocation');

	        google.maps.event.trigger(input, 'keydown', {keyCode:40});
			google.maps.event.trigger(input, 'keydown', {keyCode:13});

			$(".pac-container .pac-item:first").focus();
			$(".pac-container .pac-item:first").click();

	        var newplace = autocomplete.getPlace();

	        //console.log('NewPlace: ', newplace);
	        
	        return false;
    	} catch (e) {
			getOfferDetails();
    	}
	}
  	else
  	{
  		place = autocomplete.getPlace();
		//console.log('Found place: ', place);

		customerPlace = place;

	  	var address = '';
	  	if (place.address_components) {
			address = [
		  		(place.address_components[0] && place.address_components[0].short_name || ''),
		  		(place.address_components[1] && place.address_components[1].short_name || ''),
		  		(place.address_components[2] && place.address_components[2].short_name || '')
			].join(' ');
	  	}

	  	currPlace = address;
      	currPlaceDetails = place;

	  	//console.log('found - lookup place: ', place);
		//console.log('found - lookup currPalce: ', currPlace);

      	getOfferDetails();  	  		
  	}
};

function showMarkers() {
	setMapOnAll(map);
}

function clearMarkers() {
	setMapOnAll(null);
}

function deleteMarkers() {
	clearMarkers();
	
	// clear all markers
	var markerCount = markers.length
	for ( var i = 0; i < markerCount; i++ )
	{
		markers.pop();
	}

	markerCluster.clearMarkers();
}

function setMapOnAll(map) {

	for (var i = 0; i < markers.length; i++) {
		markers[i].setMap(map);
		markers[i].setVisible(false);
	}
}

function get_coordinate(address) {

	if( region == null || region == '' || region == 'undefined' ) {
		region = 'us';
	}

	if(address != '') {
		$('#ajax_msg').html('<p>Loading location</p>');

		geocoder.geocode( {'address':address, 'region':region}, function(results, status) {
		
			if(status == google.maps.GeocoderStatus.OK) {
				$('#ajax_msg').html('<p></p>');
			
				$('#latitude').val( results[0].geometry.location.lat() );
				$('#longitude').val( results[0].geometry.location.lng() );

				map.setZoom(10);

				map.setCenter(results[0].geometry.location);

				var marker = new google.maps.Marker({
					map: map,
					position: results[0].geometry.location
				});
			} else {
				$('#ajax_msg').html('<p>Google map geocoder failed: '+status+'</p>');
			}
		});
	}
};

//**Libraries & Config
function loadJS (url, implementationCode, location) {
    //url is URL of external file, implementationCode is the code
    //to be called from the file, location is the location to 
    //insert the <script> element

    var scriptTag = document.createElement('script');
    scriptTag.src = url;

    scriptTag.onload = implementationCode;
    scriptTag.onreadystatechange = implementationCode;

    location.appendChild(scriptTag);
};

function jsLoadCallback(){
	console.log("JS Code Loaded");
}

function addGoogleMapsJS () {
	var googleApiKeyDefault = 'AIzaSyBB7yYGz6-vbfmwf_hpeHY-GrWfi1eOXn0';

    if ( widgetConfig.googleApiKey == undefined || widgetConfig.googleApiKey == null || 
    	 widgetConfig.googleApiKey == '' ) 
    	widgetConfig.googleApiKey = googleApiKeyDefault;

    // handle working with maps locally
	if ( window.location.href.toLowerCase().indexOf('where-to-buy') == -1 ) 
	{
		widgetConfig.googleApiKey = 'AIzaSyDVFeALjwNnfYcB2dGM-1YSF5TJZXCaOus';
	}

	var langConfig = '';

	if ( widgetConfig.googleLanguage != undefined && widgetConfig.googleLanguage != null )
	{
		langConfig = '&language=' + widgetConfig.googleLanguage;
	}

    loadJS('https://maps.googleapis.com/maps/api/js?key='+ widgetConfig.googleApiKey +'&libraries=geometry,places' + langConfig, 
            googleLibraryCallback, document.body);
    loadJS('https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js',
            jsLoadCallback, document.body);
}

function getProfileConfig () {

    lang = GetURLParameter("lang");
    if ( lang == "" ) lang = GetURLParameter("type");

    var dir = profileId;
    if ( lang != "" )
    {
        dir = profileId + "/" + lang;
	}
	
	var fullConfigUrl = configUrl.replace('{0}', dir);
    fullConfigUrl = fullConfigUrl.replace('{1}', profileId);

	$.ajax({
		url: fullConfigUrl,
		type: 'GET',
		success: function (data) { 
			widgetConfig = data;

			console.log('getProfileConfig: ', widgetConfig);

			if ( widgetConfig.widgetType == undefined || widgetConfig.widgetType == null )
			{
				var sPageURL = window.location;

				if ( sPageURL.href.toLowerCase().indexOf("buyonlinebuylocalsingletab") != -1 )
				{
					widgetConfig.widgetType = "BuyOnlineBuyLocalSingleTab";
				}
				else
				{
					widgetConfig.widgetType = "BuyOnlineBuyLocal";
				}
			}

			if ( widgetConfig.region == undefined || widgetConfig.region == null ) widgetConfig.region = '';
			if ( widgetConfig.localFullRange == undefined || widgetConfig.localFullRange == null ) widgetConfig.localFullRange = false;
			if ( widgetConfig.distanceUnits != undefined && widgetConfig.distanceUnits != null ) 
			{
				distanceUnits = widgetConfig.distanceUnits;
				if ( distanceUnits == "Kilometers" ) maxRange = maxRange * 1.6;
			}

			if ( widgetConfig.show24Hour != undefined && widgetConfig.show24Hour != null )
				show12Hour = !widgetConfig.show24Hour;

			if ( widgetConfig.campaignTag != undefined && widgetConfig.campaignTag != null && widgetConfig.campaignTag != '' )
				tag = widgetConfig.campaignTag;

			if ( widgetConfig.localInstructions == undefined || widgetConfig.localInstructions == "undefined" )
				widgetConfig.localInstructions = '';

			if ( widgetConfig.noLocalStock == undefined || widgetConfig.noLocalStock == "undefined" )
				widgetConfig.noLocalStock = '';

			if ( widgetConfig.useLateMapView == undefined || widgetConfig.useLateMapView == "undefined" )
				widgetConfig.useLateMapView = false;  


			var paramTag = GetURLParameter("campaignTag");

			if ( paramTag != "" )
				tag = paramTag;

			/*
			if ( !widgetConfig.lateLoadMap && !mapLoaded ) 
			{
			*/
				addGoogleMapsJS();	
			/*
			}
			else
			{
				//console.log('Hiding the local animation');
				$('.localList-loading').hide();
				$('#localList').append('<div class="oosmessage">' + widgetConfig.localInstructions + '</div>');
			}
			*/

			if ( widgetConfig.useLateMapView )
			{
				console.log('Calling getCustomerLocation - 912');
				getCustomerLocation();
			}
			
			initWidget();
		}
	});
};

function getProfileCSS () {

    lang = GetURLParameter("lang");
    if ( lang == "" ) lang = GetURLParameter("type");

    var dir = profileId;
    if ( lang != "" )
    {
        dir = profileId + "/" + lang;
	}
	
	var fullConfigUrl = configUrl.replace('{0}', dir);

	$('head').append('<link rel="stylesheet" href="../config/'+dir+'/'+profileId+'-widget-style.css" type="text/css" />');
};

function setEnvironment () {

	var tempEnv = GetURLParameter("env");

	if ( tempEnv != "" && tempEnv.toLowerCase() != "prod" )
	{
		env = tempEnv;
		petsCall = petsCall.replace("pets", "pets-"+env);
		pcatOffersCall = pcatOffersCall.replace("productcatalog", "productcatalog-"+env);
		petsOAuth = petsOAuth.replace("locations", "locations-"+env);
	}
}

function GetURLParameter (sParam) {
	var sPageURL = window.location.search.substring(1);
    var sURLVariables = sPageURL.split('&');
    for (var i = 0; i < sURLVariables.length; i++)
    {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam)
        {
            return sParameterName[1];
        }
    }
    return "";
};

function addExternalJS () {
	if ( widgetConfig.addExternalJS != undefined && widgetConfig.addExternalJS != null && widgetConfig.addExternalJS )
	{
		lang = GetURLParameter("lang");
    	if ( lang == "" ) lang = GetURLParameter("type");

    	var dir = profileId;
    	if ( lang != "" )
    	{
	        dir = profileId + "/" + lang;
		}

		$.getScript( '../config/'+dir+'/'+profileId+'-extra.js', function () { 
			console.log("External JS loaded") 

			if ( typeof addExternalClickHandlers === "function")
			{
				addExternalClickHandlers();
			}
		});
	}
}

function addProfileLogo () {

	if ( widgetConfig.hideBrandLogo != undefined && widgetConfig.hideBrandLogo != null && widgetConfig.hideBrandLogo )
	{
		$('#brand_logo').hide();
	}
	else
	{
		$('#brand_logo').attr("src", "../config/"+profileId+"/"+profileId+"-logo.png");	
	}
	
};

function processExtraParams() {
	if ( widgetConfig.extraParams != undefined && widgetConfig.extraParams != null )
	{
		var extras = widgetConfig.extraParams.split(',');

		for ( var i in extras )
		{
			var extra = extras[i];

			if ( extra == "style" )
			{
				var style = GetURLParameter("style");
				$('#wtb-container').addClass(style);
			}
		}
	}
}

function customiseTextEntries () {

	if ( widgetConfig.mapInput != undefined && widgetConfig.mapInput != null ) {
		$("#searchLocation").attr("placeholder", widgetConfig.mapInput).blur();
		$('#startInput').attr("placeholder", widgetConfig.mapInput).blur();
	}

	if  ( widgetConfig.localInstructions == undefined || widgetConfig.localInstructions == '' )
		widgetConfig.localInstructions = widgetConfig.noLocalStock;


	$('#localList').append('<div class="oosmessage">' + widgetConfig.localInstructions + '</div>');	

	//console.log('customiseTextEntries - noOnlineStock: ' + widgetConfig.noOnlineStock );

	if ( widgetConfig.noOnlineStock != undefined && widgetConfig.noOnlineStock != null )
		$('#' + onlineContainer + ' .oosmessage').html(widgetConfig.noOnlineStock);

	if ( widgetConfig.onlineTabName == undefined || widgetConfig.onlineTabName == null || widgetConfig.onlineTabName == '' )
		widgetConfig.onlineTabName = "Buy Online";

	if ( widgetConfig.localTabName == undefined || widgetConfig.localTabName == null || widgetConfig.localTabName == '' )
		widgetConfig.localTabName = "Find Locally";

	if ( widgetConfig.locationsTabName == undefined || widgetConfig.locationsTabName == null || widgetConfig.locationsTabName == '' )
		widgetConfig.locationsTabName = "Locations";

	if ( widgetConfig.directionsTabName == undefined || widgetConfig.directionsTabName == null || widgetConfig.directionsTabName == '' )
		widgetConfig.directionsTabName = "Directions";

	if ( widgetConfig.widgetType != "BuyOnlineBuyLocalSingleTab" )
	{
		$("#online-tab").text(widgetConfig.onlineTabName);
		document.getElementById("offline-tab").text = widgetConfig.localTabName;

		if ( document.getElementById("locations-tab") != null )
			document.getElementById("locations-tab").text = widgetConfig.locationsTabName;

		if ( document.getElementById("directions-tab") != null )
			document.getElementById("directions-tab").text = widgetConfig.directionsTabName;
	}

	if ( widgetConfig.localResultTemplate != undefined && widgetConfig.localResultTemplate != null && widgetConfig.localResultTemplate != '' )
	{
		buyLocalTemplate = widgetConfig.localResultTemplate;
	}

	if ( widgetConfig.onlineResultTemplate != undefined && widgetConfig.onlineResultTemplate != null && widgetConfig.onlineResultTemplate != '' )
	{
		//console.log("buyOnlineTemplate set: " + widgetConfig.onlineResultTemplate);
		buyOnlineTemplate = widgetConfig.onlineResultTemplate;
	}

	if ( widgetConfig.disclaimerText != undefined && widgetConfig.disclaimerText != null )
	{
		$('.disclaimer').html(widgetConfig.disclaimerText);
	}

	if ( widgetConfig.distanceOptions == undefined && widgetConfig.distanceOptions == null )
	{
		widgetConfig.distanceOptions = [5,10,20,50];
	}

	if ( widgetConfig.buyNowLabel == undefined && widgetConfig.buyNowLabel == null )
	{
		widgetConfig.buyNowLabel = "Buy Now";
	}

	if ( widgetConfig.unavailableLabel == undefined && widgetConfig.unavailableLabel == null )
	{
		widgetConfig.unavailableLabel = "Unavailable";
	}

	if ( widgetConfig.startAddressLabel != undefined && widgetConfig.startAddressLabel != '' )
	{
		console.log('setting startAddress to ' + widgetConfig.startAddressLabel);
		$('#startLabel').html(widgetConfig.startAddressLabel);
	}

	if ( widgetConfig.startInstruction != undefined && widgetConfig.startInstruction != '' )
	{
		console.log('setting startStoreInstruction to ' + widgetConfig.startInstruction);
		$('#startStoreInstruction').html(widgetConfig.startInstruction);
	}

	var dropdownStr = '<select id="rangeSelect" name="rangeSelect" class="distance form-control">'; 

	var unitStr = "Miles";
	if ( distanceUnits == "Kilometers" ) unitStr = "Km";

	var optionBaseStr = '<option value="{distVal}">{distVal} ' + unitStr + '</option>';
	var optionSelectedBaseStr = '<option value="{distVal}" selected>{distVal} ' + unitStr + '</option>';

	for ( var i in widgetConfig.distanceOptions )
	{
		var distance = widgetConfig.distanceOptions[i];

		var distStr = optionBaseStr.replaceAll('{distVal}', distance);

		// Check if this should be marked as selected
		if ( widgetConfig.distanceDefault != undefined && widgetConfig.distanceDefault != null && 
			 widgetConfig.distanceDefault == distance)
		{
			distStr = optionSelectedBaseStr.replaceAll('{distVal}', distance);
		}

		dropdownStr += distStr;

		validDropdown = true;
	}

	dropdownStr += '</select>';

	$('#rangeSelect').remove();
	$('#searchBoxParent').append(dropdownStr);
	
}

function showHideParts () {
	if ( widgetConfig.hideTitle != undefined && widgetConfig.hideTitle != null && widgetConfig.hideTitle )
	{
		$('.wtb-title').hide();
	}

	if ( widgetConfig.titleOverride != undefined && widgetConfig.titleOverride != null && widgetConfig.titleOverride != '' )
	{
		//console.log('titleOverride - adding detail: ' + widgetConfig.titleOverride);
		$('.wtb-title').html(widgetConfig.titleOverride);
		$('.wtb-title').show();
	}

	if ( widgetConfig.lateLoadMap != undefined && widgetConfig.lateLoadMap != null && widgetConfig.lateLoadMap )
	{
		$('.wtb-local').hide();
		$('#localSplashCover').show();
	}

	if ( widgetConfig.mapDirections == undefined || 
		(widgetConfig.mapDirections != undefined && widgetConfig.mapDirections != null && !widgetConfig.mapDirections) )
	{
		$('#localTabs').css('display','none');
	}

	if ( widgetConfig.variantDropdown != undefined && widgetConfig.variantDropdown != null && 
		 widgetConfig.variantDropdown == "swap" )
	{	
		$('.group').append(searchFormTemplate);
		$('.map-search').hide();
	}
	else
	{
		var dropdownPlacement = "#wtbMapContainer";
		var defaultPlacement = true;

		if ( widgetConfig.variantLocation != undefined && widgetConfig.variantLocation != null && widgetConfig.variantLocation != ''  )
		{
			dropdownPlacement = '#' + widgetConfig.variantLocation;
			defaultPlacement = true;
		}

		if ( widgetConfig.localSearchLocation != undefined && widgetConfig.localSearchLocation != null && widgetConfig.localSearchLocation != '' )
		{
			dropdownPlacement = widgetConfig.localSearchLocation;
			defaultPlacement = false;
		}

		//console.log('Local Search Location: ' + dropdownPlacement);

		if ( defaultPlacement )
		{
			$(dropdownPlacement).prepend(searchFormTemplate);
		}
		else
		{
			$(dropdownPlacement).append(searchFormTemplate);
		}
	}

	if ( widgetConfig.localResultsExtra != undefined && widgetConfig.localResultsExtra != null && widgetConfig.localResultsExtra != '' )
	{
		//console.log('applying localResultsExtra: ' + widgetConfig.localResultsExtra );
		$('#location').prepend(widgetConfig.localResultsExtra);
	}
/*
	if ( widgetConfig.localSearchLocation != undefined && widgetConfig.localSearchLocation != null )
	{
		console.log('Adding locla search to: ' + widgetConfig.localSearchLocation);
		$(widgetConfig.localSearchLocation).append(searchFormTemplate);	
	}
*/
	if ( widgetConfig.hideTabs != undefined && widgetConfig.hideTabs != null && widgetConfig.hideTabs )
		$('.wtb-nav').css('display','none');

	var singleTabOpt = GetURLParameter("singleTab");

	if ( singleTabOpt != '' ) widgetConfig.singleTab = singleTabOpt;

	if ( widgetConfig.singleTab != undefined )
	{
		if ( widgetConfig.singleTab == 'local' )
		{
			$('.nav-tabs a[href="#online"]').hide();
		}
		else if ( widgetConfig.singleTab == 'online' )
		{
			$('.nav-tabs a[href="#offline"]').hide();
			widgetConfig.lateLoadMap = true;
		}
	}

	if ( widgetConfig.resultsSideBySide != undefined && widgetConfig.resultsSideBySide != null && widgetConfig.resultsSideBySide )
	{
		$('#myTabContent').removeClass();
		$('#myTabContent').addClass("tab-content col wtb-col-sm-6");

		$('#externalOnlineContent').removeClass();
		$('#externalOnlineContent').addClass("wtb-online wtb-col-sm-6");
		$('#externalOnlineContent').css('display', 'block');
        
		onlineContainer = "externalOnlineList";
		$('.nav-tabs a[href="#offline"]').tab('show');
		$('.wtb-nav').css('display','none');

		$('#searchLocation').on('click', function () {

			$('#myTabContent').removeClass();
			$('#myTabContent').addClass("tab-content col wtb-col-sm-12");
			$('#externalOnlineContent').removeClass();
			$('#externalOnlineContent').addClass("wtb-online wtb-col-sm-0");
        });
        
	}

	$('#searchLocation').on('click', function() {

		console.log('Caught searchLocation click');

		$('#directionsSelect').show();
		$('#directionsLocations').hide();

		$('#directionRoute').html('');

		$( "#locations-tab" ).click();
	});

	var startTab = GetURLParameter("startTab");

	if ( (widgetConfig.startTab != undefined && widgetConfig.startTab != null && widgetConfig.startTab == "local" && startTab != "online") || startTab == "local" )
	{
		widgetConfig.startTab = "local";
		$('.nav-tabs a[href="#offline"]').tab('show');
    }
    else if ( (widgetConfig.startTab != undefined && widgetConfig.startTab != null && widgetConfig.startTab == "online") || startTab == "online" )
    {
    	widgetConfig.startTab = "online";
		$('.nav-tabs a[href="#online"]').tab('show');
    }

/*
    if (widgetConfig.startTab == "online")
    {
    	var localTab1 = $('.wtb-nav .nav .nav-item:last-child');
    	console.log('localtab - jquery: ', localTab1);

    	var localTab = document.querySelector('.wtb-nav .nav .nav-item:last-child');
    	console.log('localtab: ', localTab);

    	var displayStyle = localTab.currentStyle ? localTab.currentStyle.display :
                              getComputedStyle(localTab, null).getPropertyValue("display");

    	console.log('displayStyle: ' + displayStyle);

        if ( displayStyle == 'none' ) widgetConfig.singleTab = "online";
    }
*/
    if ( widgetConfig.singleTab == "online" )
    {
    	widgetConfig.startLongitude = '';
    	widgetConfig.startLatitude = '';
    }

	if ( widgetConfig.featureCollapse != undefined && widgetConfig.featureCollapse != null && widgetConfig.featureCollapse)
	{
		if (widgetConfig.featureCollapseDiv != undefined && widgetConfig.featureCollapseDiv != null && 
			widgetConfig.featureCollapseText != undefined && widgetConfig.featureCollapseText != null )
		{
			var collapseContents = $('#'+widgetConfig.featureCollapseDiv).html();
			featureCollapseTemplate = featureCollapseTemplate.replace('{wtb_collapseContents}', collapseContents);
			featureCollapseTemplate = featureCollapseTemplate.replace('{wtb_collapseText}', widgetConfig.featureCollapseText);
			$('#'+widgetConfig.featureCollapseDiv).html(featureCollapseTemplate);
		}
	}

	if ( widgetConfig.CABranding != undefined && widgetConfig.CABranding != null && !widgetConfig.CABranding )
	{
		$('#CABranding').html('');
	}
}

function setConfiguredCSS () {
	if ( widgetConfig.mapContainerClass != undefined && widgetConfig.mapContainerClass != null )
	{
		$('#wtbMapContainer').removeClass();
		$('#wtbMapContainer').addClass(widgetConfig.mapContainerClass);
	}
	
	if ( widgetConfig.localResultsContainerClass != undefined && widgetConfig.localResultsContainerClass != null )
	{
		$('#wtbLocalResultsContainer').removeClass();
		$('#wtbLocalResultsContainer').addClass(widgetConfig.localResultsContainerClass);
	}
}

function addDropdownHandlers () {
	if ( widgetConfig.variantDropdown != undefined && widgetConfig.variantDropdown != null && 
		 widgetConfig.variantDropdown != "none" )
	{
		$( "#variantSelect" ).on('change', function () {
	  		model = $('#variantSelect').val();

	  		getOfferDetails();
		});
	}

    if (widgetConfig.startTab = "local" && widgetConfig.variantDropdown == "online")
    {
        $('#variantSelect').hide();
    }
    else if (widgetConfig.startTab = "local" && widgetConfig.variantDropdown == "swap")
    {
        $('.map-search').show();
        $('#variantSelect').hide();
    }
}

function addEventHandlers() {
	$( "#online-tab" ).on('click', function () {
		if ( widgetConfig.variantDropdown != undefined && widgetConfig.variantDropdown != null &&
			  (widgetConfig.variantDropdown == "online" || widgetConfig.variantDropdown == "both" ) )
		{
			$('#variantSelect').show();
		}
		else if ( widgetConfig.variantDropdown != undefined && widgetConfig.variantDropdown != null && 
			      widgetConfig.variantDropdown == "swap" )
		{
			$('#variantSelect').show();
			$('.map-search').hide();
		}
		else
		{
			$('#variantSelect').hide();
		}
	});

	$( "#offline-tab" ).on('click', function () {
		if ( widgetConfig.variantDropdown != undefined && widgetConfig.variantDropdown != null && 
			  (widgetConfig.variantDropdown == "local" || widgetConfig.variantDropdown == "both" ) )
		{
			$('#variantSelect').show();
		}
		else if ( widgetConfig.variantDropdown != undefined && widgetConfig.variantDropdown != null && 
			      widgetConfig.variantDropdown == "swap" )
		{
			$('#variantSelect').hide();
			$('.map-search').show();
		}
		else
		{
			$('#variantSelect').hide();
		}
	});

	$("#showLocal").on('click', function() {

		//addGoogleMapsJS();
		initMap();

		if ( typeof localDisplayUpdate === "function" ) {
			console.log('Calling: localDisplayUpdate');
			localDisplayUpdate();
		}
		
		$('#localSplashCover').hide();
		$('.wtb-local').show();
	});
	
	$('#search-icon').on('click', function(e){
		//place_changed();
		//console.log('triggering keyPress: ' + initialSearch, e);

		if ( initialSearch ) return;

		var textInput = document.getElementById('searchLocation');
		var suggestionCount = $(".pac-container .pac-item").length;

		//console.log('currentLocation: ' + textInput.value);

		if ( suggestionCount > 0 )
		{
			// build "keydown" event
	    	var e = new KeyboardEvent( "keydown", { 
	    		bubbles:true, cancelable:true, 
	    		char:String.fromCharCode(13), 
	    		key:String.fromCharCode(13), 
	    		shiftKey:false, ctrlKey:false, altKey:false,
	    		keyCode: 13, key: "Enter", code: "Enter", which: "13" } );
	    	Object.defineProperty(e, 'keyCode', {get : function() { return this.keyCodeVal; } });     
	    	e.keyCodeVal = 13;
	    	textInput.dispatchEvent(e);
	    }
	    else
	    {
	    	place_changed();
	    }
	});
	
}

//Offers & Local
function getOfferDetails () {

	if  ( model == undefined || model == null || model == '' ) return;

	if ( widgetConfig.pcatUser != undefined && widgetConfig.pcatUser != null )
		user = widgetConfig.pcatUser;

	var locLat  = widgetConfig.startLatitude;
	var locLong = widgetConfig.startLongitude;

	multiModel = false;

	if ( !widgetConfig.autoLocalSearch )
	{
		locLat  = "";
		locLong = "";
		initialiseMap(widgetConfig.startLatitude, widgetConfig.startLongitude);
	}

	if(region==null || region == '') {
		region = 'us';
	}
	
	distancecode = 1;

	currRange = $("#rangeSelect").val();
	var selectedRange = currRange;

	var user = "pcat.aegpowertoolsau@channeladvisor.com";

	if ( widgetConfig.pcatUser != undefined && widgetConfig.pcatUser != null )
		user = widgetConfig.pcatUser;	

	if( currPlaceDetails != undefined && currPlaceDetails != null )
	{
		locLat = currPlaceDetails.geometry.location.lat();
		locLong = currPlaceDetails.geometry.location.lng();
		initialiseMap(currPlaceDetails.geometry.location.lat(), currPlaceDetails.geometry.location.lng());
	}	

	if ( initialSearch && customerPlace != undefined )
	{
		//console.log("Customer Location found: ", customerPlace)	;
		locLat = customerPlace.geometry.location.lat();
		locLong = customerPlace.geometry.location.lng();
		initialiseMap(customerPlace.geometry.location.lat(), customerPlace.geometry.location.lng());
	} 
	else if ( widgetConfig.useLateMapView != undefined && widgetConfig.useLateMapView )
	{
		if ( widgetConfig.lateMapViewInitialSearch != undefined && widgetConfig.lateMapViewInitialSearch && !placeChanged)
		{
			locLat = widgetConfig.startLatitude; 
			locLong = widgetConfig.startLongitude;
		}
		
		if ( widgetConfig.lateMapViewInitialSearch != undefined && !widgetConfig.lateMapViewInitialSearch )
		{
			locLat = ''; 
			locLong = '';
		}
	}

	if ( model.indexOf(',') != -1 ) 
	{
		// https://productcatalog.channeladvisor.com/api/v1/offers/modellist/{0}?IncludeVariations=TRUE
		// https://productcatalog.channeladvisor.com/api/v1/offers/modellist/00019800703318,00019800002060,00019800708351?&maxLocationsPerRetailer=25&maxResultsPerRetailer=25&IncludeVariations=TRUE&Latitude=40.8136&Longitude=-96.7026&distanceRange=5&distanceUnit=Miles&IncludeVariations=true
		pcatOffersCall = pcatOffersCall.replace('models', 'modellist');

		console.log("Setting multiModel to true");
		multiModel = true;
	}

	var pcatOfferUrl = pcatOffersCall.replace('{0}', model);

    if ( locLat != '' ) pcatOfferUrl += '&Latitude=' + locLat;
	if ( locLong != '' ) pcatOfferUrl += '&Longitude=' + locLong;
	if ( currRange != null ) pcatOfferUrl += '&distanceRange='+currRange+'&distanceUnit='+distanceUnits;

	if ( guidParam != '' ) pcatOfferUrl += '&customSessionId='+guidParam;

	// need productImnages to be pulled in
	pcatOfferUrl += '&IncludeVariations=true';

	if ( tag != "brandsite" )
	{
		pcatOfferUrl += "&tag=" + tag;
	}

    var authToken = widgetConfig.authToken;

    if ( widgetConfig.WTBAuthToken != undefined && widgetConfig.WTBAuthToken != null )
    	authToken = widgetConfig.WTBAuthToken;

    //console.log('Showing the local animation');
    $('.localList-loading').show();

    //console.log('setting authToken: ' + authToken);

	$.ajax({
		url: pcatOfferUrl,
		type: 'GET',
		beforeSend: function (xhr) {
        	/* Authorization header */
	        xhr.setRequestHeader("Authorization", 'api-key ' + authToken);
    	},
		success: function (data) { 

			console.log("pcatOfferUrl: ", data);

			$('.'+onlineRetailerContainer).empty();
			$('#' + onlineContainer).empty();

			onlineRetailerHTML = [];
			productRetailers = [];

			if ( multiModel )
			{
				for ( var p in data.Products )
				{
					var product = data.Products[p];
					console.log('multiModel product: ', product);
					processVariantData(product);
					getRetailerList(product);
				}

				console.log ('productRetailers: ', productRetailers);

				for ( var p in data.Products )
				{
					var product = data.Products[p];
					console.log('multiModel online product: ', product);

					if ( p == (data.Products.length -1) )
						lastMultiModelProduct = true;

					processOnlineResults(product);
				}

				outputOnlineResults();

				initialiseMap(locLat, locLong);

				processLocalResults(data);
				updateDisplayForLateMapView();
			}
			else
			{		
				processVariantData(data);
				getRetailerList(product);
				processOnlineResults(data);

				outputOnlineResults();

				console.log('calling initialiseMap');
				
				initialiseMap(locLat, locLong);

				console.log('calling processLocalResults');

				processLocalResults(data);
				updateDisplayForLateMapView();
			}
			
			if ( locLat != '' )
				initialSearch = false;
		},
		error: function (e) { 
			console.log('Caught Error: ', e);
		}
	});
}

function processOnlineResults (data) {

	var modelList = [];
	modelList[0] = model;

	onlineRetailerHTML[data.ModelName] = [];

	if ( widgetConfig.allVariants != undefined && widgetConfig.allVariants != null && widgetConfig.allVariants 
		&& productModels.length > 0 )
	{
		modelList = productModels;
	}

	for ( var i in modelList )
	{
		var currModel = modelList[i];

		var priceStr = '<p class="price" id="{wtb_display_name} Price">{wtb_price}</p>';

		var stockStr = '<div class="stock">' +
					   		'{wtb_stockPrice}' +
					   		'<p class="status">' +
				  		   		'<b>{wtb_inStockText}</b>' +
					   		'</p>' +
					   	'</div>';

		var outOfStockStr = '<div class="stock outstock">' +
								'{wtb_stockPrice}'+
								'<p class="status">' +
							    	'<b>{wtb_outOfStockText}</b>' +
							 	'</p>' +
							'</div>';

		var nearbyStr = '<p aria-label="Check {wtb_display_name} nearby" id="checkNearby">' +
							//'<br/>' +
							'<b>Check Nearby</b>' +
						'</p>';


		var addToCartStr = '<a class="btn btn-addtocart AddToCartLink" href="javascript:void(0)" target="_blank" cartUrl="{wtb_cartURL}" cartRetailer="{wtb_cartTRetailer}" >' +
								'Add to Cart' +
							'</a>'

							// Update usage of buyNowStr to buyNowSingleStr
							// Add BuyNowStr to onlineTemplate and hide if addToCartOnly setting is used
		var buyNowSingleStr = '<span id="{wtb_display_name}BuyNow">' +
							  	'<a href="{store_deeplink_url}" target="_blank" class="btn btn-buynow " buyNowName="{wtb_buyNowName}" aria-label="Buy Now from {wtb_display_name}">' +
									'{wtb_buybuttontext}' +
								'</a>' +
							  '</span>'
/*
		var buyNowStr =	'<span id="{wtb_display_name}BuyNow">' +
							'<a href="{store_deeplink_url}" target="_blank" class="btn btn-buynow " buyNowName="{wtb_buyNowName}" aria-label="Buy Now from {wtb_display_name}">' +
								'<i class="material-icons valign-center">open_in_new</i>' +
								'{wtb_buybuttontext}' +
							'</a>' +
						'</span>'
*/
		
		var addToCart = '<div class="add" >' +
						'<span>' +
							'<a href="{wtb_add_to_cart_link}" target="_blank" class="btn btn-addtocart" aria-label="Buy Now from {wtb_add_to_cart_display_name}">' +
								'<i class="material-icons valign-center">open_in_new</i>' +
								'{wtb_addToCartLabel}' +
							'</a>' +
						'</span>' +
						'</div>' ;

	

		var buyNowStr = '<span id="{wtb_display_name}BuyNow">' +
							'<a href="{store_deeplink_url}" target="_blank" class="btn btn-buynow {wtb_availability}" aria-label="Buy Now from {wtb_display_name}">' +
								'{wtb_buybuttontext}' +
							'</a>' +
						'</span>'
		
		var onlinePromotionStr = '<div class="offer"><p class="promo" data-toggle="tooltip" data-placement="top" data-html="true" title="{tooltipTxt}" >' +
									'Offer' +
						   		 '</p></div>';

		var buyNowText = widgetConfig.buyNowLabel;

		//console.log('widgetConfig.widgetType: ' + widgetConfig.widgetType);

		if ( data.OnlineRetailers.length > 0 )
		{
                
			for (var o in data.OnlineRetailers )
			{
				var currStore = data.OnlineRetailers[o];
				var onlinePromo = '';
				var stockReplace = outOfStockStr;

				//console.log('OnlineRetailers check: ' + currStore.DisplayName);

				// Check if filtering is required
				if ( widgetConfig.onlineFiltering != undefined && widgetConfig.onlineFiltering != null && 
					 widgetConfig.onlineFiltering )
				{
					if ( widgetConfig.validOnlineRetailers != undefined && widgetConfig.validOnlineRetailers != null && 
						 widgetConfig.validOnlineRetailers != '' )
					{
						var filterList = widgetConfig.validOnlineRetailers.split('|');

						var isValid = false;

						//console.log('OnlineRetailers retailers: ', filterList);

						for ( var i in filterList )
						{
							var retailer = filterList[i];

							if ( currStore.DisplayName.toLowerCase().indexOf(retailer.toLowerCase()) != -1) {
								isValid = true;
								break;
							}
						}

						if ( !isValid ) continue;
					}
				}

				//  
				if ( widgetConfig.useExternalOnlineFiltering != undefined && widgetConfig.useExternalOnlineFiltering != null && 
			    	 widgetConfig.useExternalOnlineFiltering && typeof filterOnlineWTBResults === "function" )
				{
					//console.log("Calling filterOnlineWTBResults: " + currStore.Name);
					isValid = filterOnlineWTBResults(currStore);

					//console.log('filterOnlineWTBResults result: ' + isValid);

					if ( !isValid ) continue;
				}

				//console.log('OnlineRetailers addition: ', currStore);
				
				if ( widgetConfig.hideOutOfStock && currStore.Availability != "Available" ) continue;

				if( currStore.Promotions != undefined && currStore.Promotions != null && 
					currStore.Promotions.length > 0) {

					var tooltipTxt = '';

					for ( var p in currStore.Promotions )
					{
						var currPromo = currStore.Promotions[p];

						//console.log('OnlinePromotions: ', currPromo);

						if ( tooltipTxt == '' )
						{
							tooltipTxt = currPromo.PromotionalMessage;
						}
						else
						{
							tooltipTxt += '<br>' + currPromo.PromotionalMessage;
						}
					}	

					onlinePromo = onlinePromotionStr.replace('{tooltipTxt}', tooltipTxt);	
				} else {
					onlinePromo = '<div class="offer"></div>';
				}

				//console.log('OnlinePromotions set: ', onlinePromo);
				
				onlineData[currStore.Name] = {};
				onlineData[currStore.Name]["price"] = currStore.Price;
				onlineData[currStore.Name]["buyNow"] = currStore.ProductLink;
				
				if ( currStore.Availability == "Available" ) 
				{
					stockReplace = stockStr;
				}
				else
				{
					buyNowText = widgetConfig.unavailableLabel;
				}

				var productPrice = currStore.price;

				if ( widgetConfig.useFormattedPrice != undefined && widgetConfig.useFormattedPrice )
					productPrice = currStore.PriceFormatted;

				var defaultProductPrice = false;

				//console.log("Price Check: " + productPrice + "|" + widgetConfig.zeroPriceText);

				if ( widgetConfig.zeroPriceText != undefined && 
					( productPrice == "0" || productPrice == "0.00" || productPrice == 0.00 || productPrice == 0 ) )
				{
					productPrice = widgetConfig.zeroPriceText;
					defaultProductPrice = true;

					//console.log("product price reset: " + productPrice);
				}

            	if ( widgetConfig.noOnlineStock != undefined && widgetConfig.noOnlineStock != null )
                	$('#'+onlineContainer +" .oosmessage").hide();

				//console.log("availability text: " + buyNowText + "|" + currStore.Availability);

				if ( widgetConfig.widgetType == "BuyOnlineBuyLocalSingleTab" )
				{
					//console.log("online - singleTab");

					if ( productPrice != null ) 
					{
						var priceHTML = priceStr.replace('{wtb_price}', widgetConfig.currencySymbol + "" + productPrice);

						if ( defaultProductPrice ) priceStr.replace('{wtb_price}', productPrice);

						if (showPrice) $('#online_price').html(priceHTML);

						var buyNowHTML = buyNowSingleStr.replaceAll('{store_deeplink_url}', currStore.deeplink_url);
						buyNowHTML = buyNowHTML.replaceAll('{wtb_display_name}', currStore.DisplayName);
						buyNowHTML = buyNowHTML.replaceAll('{wtb_buyNowName}', currStore.DisplayName);
						buyNowHTML = buyNowHTML.replaceAll('{wtb_buybuttontext}', buyNowText);
						$('#online_offer').html(buyNowHTML);
					}
				}
				else
				{
					//console.log("online - simple");
					var buyOnlineEntry = '';

					if ( (widgetConfig.onlineTemplate == "simple" || widgetConfig.showSimpleOnline) && version != '2.0' )
					{
						var inStockText = 'instock';
						var outOfStockText = 'outstock';

						if ( widgetConfig.inStockText != undefined && widgetConfig.inStockText != null )
						{
							inStockText = widgetConfig.inStockText;
						}

						if ( widgetConfig.outOfStockText != undefined && widgetConfig.outOfStockText != null )
						{
							outOfStockText = widgetConfig.outOfStockText;
						}

						var storePrice = currStore.Price;

						if ( widgetConfig.useFormattedPrice != undefined && widgetConfig.useFormattedPrice )
							storePrice = currStore.PriceFormatted;

						buyOnlineEntry = buyOnlineSimpleTemplate.replaceAll('{store_deeplink_url}', currStore.ProductLink);	
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_display_name}', currStore.DisplayName);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_logo_url}', currStore.LogoUrl);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_stock}', currStore.Availability == "Available" ? inStockText : outOfStockText);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_onlinePrice}', currStore.Price != null ? widgetConfig.currencySymbol + "" + storePrice : '');

						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_onlinePromotions}', onlinePromo);	

						//console.log("setting buyNowText: " + buyNowText);

						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_buybuttontext}', buyNowText);

						/*
						if ( multiModel )
						{
							//console.log('multiModel simple - ' + currStore.Name + ': ' + productRetailers[currStore.Name] + '|' + currStore.Availability );
							if ( productRetailers[currStore.Name] == false && (currStore.Availability == "Available") )
							{
								$('#' + onlineContainer).append(buyOnlineEntry);
								productRetailers[currStore.Name] = true;
							}
							else if ( productRetailers[currStore.Name] == false && lastMultiModelProduct )
							{
								$('#' + onlineContainer).append(buyOnlineEntry);
							}
						}
						else
						{
							$('#' + onlineContainer).append(buyOnlineEntry);	
						}
						*/

						retailerNumber++;
					}
					else if ( widgetConfig.onlineTemplate == "descriptive" && version != '2.0' )
					{
						//console.log("online - Descriptive");

						var inStockText = 'instock';
						var outOfStockText = 'outstock';

						if ( widgetConfig.inStockText != undefined && widgetConfig.inStockText != null )
						{
							inStockText = widgetConfig.inStockText;
						}

						if ( widgetConfig.outOfStockText != undefined && widgetConfig.outOfStockText != null )
						{
							outOfStockText = widgetConfig.outOfStockText;
						}

						buyOnlineEntry = buyOnlineDescriptiveTemplate.replaceAll('{wtb_display_name}', currStore.DisplayName);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_stock}', currStore.Availability == "Available" ? inStockText : outOfStockText);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_logo_url}', currStore.LogoUrl);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{store_deeplink_url}', currStore.DisplayName);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_productname}', productLabels[model]);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_productsize}', productSizes[model]);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_buybuttontext}', buyNowText);

						/*
						if ( multiModel )
						{
							//console.log('multiModel descriptive: ' + productRetailers[currStore.Name] + '|' + currStore.Availability );
							if ( productRetailers[currStore.Name] == false && (currStore.Availability == "Available") )
							{
								$('#' + onlineContainer).append(buyOnlineEntry);
								productRetailers[currStore.Name] = true;
							}
							else if ( productRetailers[currStore.Name] == false && lastMultiModelProduct )
							{
								$('#' + onlineContainer).append(buyOnlineEntry);
							}
						}
						else
						{
							$('#' + onlineContainer).append(buyOnlineEntry);	
						}
						*/

						retailerNumber++;
					}
					else if ( widgetConfig.widgetType == "BuyOnlineBuyLocalFullTab" && version != '2.0' )
					{
						//console.log("online - fullTab");

						var priceReplace = '';
						if ( currStore.price != null ) priceReplace = widgetConfig.currencySymbol + "" + currStore.Price;

						buyOnlineEntry = buyOnlineSimpleBuyNowTemplate.replaceAll('{store_deeplink_url}', currStore.ProductLink);	
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_display_name}', currStore.DisplayName);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_logo_url}', currStore.LogoUrl);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_buybuttontext}', buyNowText);

						var buttonText = widgetConfig.onlineButtonText;

						if ( widgetConfig.showOnlinePrice )
						{
							buttonText = priceReplace + " " + buttonText;
						}

						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_buy_now_text}', buttonText);

						/*
						if ( multiModel )
						{
							//console.log('multiModel BuyOnlineBuyLocalFullTab: ' + productRetailers[currStore.Name] + '|' + currStore.Availability );
							if ( productRetailers[currStore.Name] == false && (currStore.Availability == "Available") )
							{
								$('#' + onlineContainer).append(buyOnlineEntry);
								productRetailers[currStore.Name] = true;
							}
							else if ( productRetailers[currStore.Name] == false && lastMultiModelProduct )
							{
								$('#' + onlineContainer).append(buyOnlineEntry);
							}
						}
						else
						{
							$('#' + onlineContainer).append(buyOnlineEntry);	
						}
						*/

						retailerNumber++;
					}
					else
					{
						//console.log("online - default");

						var priceReplace = '';
						var nearbyReplace = '';
						var inStockText = 'Available';
						var outOfStockText = 'Out of Stock';
						var addToCartReplace = '';

						var onlineBuyNowStr = buyNowStr;

						if ( widgetConfig.inStockText != undefined && widgetConfig.inStockText != null )
						{
							inStockText = widgetConfig.inStockText;
						}

						if ( widgetConfig.outOfStockText != undefined && widgetConfig.outOfStockText != null )
						{
							outOfStockText = widgetConfig.outOfStockText;
						}

						if ( currStore.DisplayName != "Amazon" ) nearbyReplace = nearbyStr; //&& customerLocation != "blocked"
						if ( currStore.Price != null ) priceReplace = priceStr;

						buyOnlineEntry = buyOnlineTemplate.replaceAll('{wtb_logo_url}', currStore.LogoUrl);

						if(currStore.CartLink != null && currStore.Availability == "Available"){

							addToCartReplace = addToCartStr; // replace check with new addToCart data
							
							//console.log('CartLink: ', currStore.CartLink);
							var addToCartLabel = 'Add To Cart';

							if ( widgetConfig.addToCartLabel != undefined && widgetConfig.addToCartLabel != '' )
								addToCartLabel = widgetConfig.addToCartLabel;

							onlineData[currStore.Name]["addToCart"] = currStore.CartLink;
							addToCartReplace = addToCart.replaceAll('{wtb_add_to_cart_link}', currStore.CartLink);
							addToCartReplace = addToCartReplace.replaceAll('{wtb_addToCartLabel}', addToCartLabel);
							//var currentAddToCart = addToCart.replaceAll('{wtb_add_to_cart_link}', currStore.CartLink);
							//buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_add_to_cart}', currentAddToCart);

							//console.log('addToCartReplace AddtoCart: ', addToCartReplace);
						} else {
							//if ( widgetConfig.showAddToCartOnly ) continue;
							buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_add_to_cart}', "");
						}

						if ( widgetConfig.showAddToCartOnly != undefined && widgetConfig.showAddToCartOnly != null && 
							 widgetConfig.showAddToCartOnly && currStore.CartLink != null)
						{
							onlineBuyNowStr = '';
						}

						var storePrice = currStore.Price;

						if ( widgetConfig.useFormattedPrice != undefined && widgetConfig.useFormattedPrice )
							storePrice = currStore.PriceFormatted;

						console.log('formattedPrice: ' + widgetConfig.useFormattedPrice + "|" + storePrice + "|" + currStore.PriceFormatted)

						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_onlineBuyNow}', onlineBuyNowStr);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_onlineStockDetails}', stockReplace);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_stockPrice}', priceReplace);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_onlineCheckNearby}', nearbyReplace);

						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_onlineAddToCart}', addToCartReplace);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_cartURL}', currStore.ProductLink);

						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_cartTRetailer}', currStore.name);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_display_name}', currStore.DisplayName);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_currency_symbol}', currStore.CurrencySymbol);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_price}', widgetConfig.currencySymbol + "" + storePrice);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{store_deeplink_url}', currStore.ProductLink);

						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_onlinePromotions}', onlinePromo);						

						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_inStockText}', inStockText);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_outOfStockText}', outOfStockText);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_buybuttontext}', buyNowText);

						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_availability}', currStore.Availability == "Available" ? inStockText : outOfStockText);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_stock}', currStore.Availability == "Available" ? "instock" : "outstock");
						
						// Extras 
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_ModelCode}', data.ModelCode);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_ModelName}', data.ModelName);
						buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_MarketingModelName}', data.MarketingModelName);

						// process attributes
						for (var attrName in data.Attributes) {
					        var attrVal = data.Attributes[attrName];

					        //console.log('onlineReplace Attr name: ' + attrName + ' | ' + attrVal);

					        buyOnlineEntry = buyOnlineEntry.replaceAll('{wtb_attr'+attrName+'}', attrVal);
					    }

						//console.log('Adding BuyOnline Entry: ' + buyOnlineEntry);

						//$('.'+onlineRetailerContainer).append(buyOnlineEntry);

						//console.log("Chesking multiModel: " + multiModel);
						/*
						if ( multiModel )
						{
							//console.log('multiModel: ' + productRetailers[currStore.Name] + '|' + currStore.Availability );
							if ( productRetailers[currStore.Name] == false && (currStore.Availability == "Available") )
							{
								$('#' + onlineContainer).append(buyOnlineEntry);
								productRetailers[currStore.Name] = true;
							}
							else if ( productRetailers[currStore.Name] == false && lastMultiModelProduct )
							{
								$('#' + onlineContainer).append(buyOnlineEntry);
							}
						}
						else
						{
							$('#' + onlineContainer).append(buyOnlineEntry);	
						}
						*/
						retailerNumber++;
					}

					onlineRetailerHTML[data.ModelName][currStore.Name] = buyOnlineEntry;

					if ( productRetailers[currStore.Name] == false && (currStore.Availability == "Available") )
					{
						productRetailers[currStore.Name] = true;
					}
				}
			}
		}
	}	
};

function outputOnlineResults ( ) {

	for ( var m in onlineRetailerHTML )
	{
		for ( var r in onlineRetailerHTML[m] ) 
		{
			//console.log('outputOnlineResults: ' + m + '|' + r + '|' + productRetailers[r]);

			var content = onlineRetailerHTML[m][r];

			var availability = false;

			if ( content.indexOf(widgetConfig.buyNowLabel) != -1 )
			{
				availability = true;
			}

			if ( multiModel )
			{
				//console.log('multiModel: ' + productRetailers[currStore.Name] + '|' + currStore.Availability );
				if ( productRetailers[r] && availability )
				{
					$('#' + onlineContainer).append(content);
					// retailer in place, stop more
					productRetailers[r] = false;
				}
				else if ( !productRetailers[r] && !availability )
				{
					$('#' + onlineContainer).append(content);
					// retailer in place, mark it 
					productRetailers[r] = true;
				}
			}
			else
			{
				$('#' + onlineContainer).append(content);	
			}
		}
	}

	console.log('retailerHTML: ', onlineRetailerHTML);
	console.log('productRetailers: ', productRetailers);
	
	if ( retailerNumber == 0 )
	{
		if ( widgetConfig.noOnlineStock != undefined && widgetConfig.noOnlineStock != null )
			$('#'+onlineContainer).append('<div class="oosmessage">' + widgetConfig.noOnlineStock + '</div>');
	}

	if ( typeof addExternalOnlineClickHandlers === "function")
	{
		addExternalOnlineClickHandlers();
	}

	
	console.log('Calling WTBOnlineLoaded');

	$(document).trigger("WTBOnlineLoaded");

	// Change visibility
	$('.wtb-box-loading').hide();
	$('.wtb-box').show();
	$('.disclaimer').show();

	$('.AddToCartLink').click(function(e){
		AddToCartClick(e);	
	});

	$('.nearby').click(function(){
		getOfferDetails();

		$('.nav-tabs a[href="#offline"]').tab('show');
	});
};

function getRetailerList (data) {

	if ( data == undefined ) return;

	for ( var r in data.OnlineRetailers )
	{
		productRetailers[data.OnlineRetailers[r].Name] = false;
	}
}

function processVariantData (data) {

	var productDescription = data.Description;
	var productSubTitle = data.ModelName;

	var productImage = data.ProductImage;

	if ( (productImage == undefined || productImage == null) && data.Variants[0] != undefined ) 
		productImage = data.Variants[0].ImageUrl;

	var modelName = data.ModelName;

	if ( widgetConfig.titleSrc != undefined && widgetConfig.titleSrc != null && 
		 widgetConfig.titleSrc != "default" )
	{
        var attrVal = getProductAttributeValue(data, widgetConfig.titleSrc);
        if ( attrVal != '' ) productDescription = attrVal;
	}

	if ( widgetConfig.subTitleSrc != undefined && widgetConfig.subTitleSrc != null && 
		 widgetConfig.subTitleSrc != "default" )
	{
		if ( widgetConfig.subTitleSrc == "modelcode" )
		{
			productSubTitle = data.ModelCode;
		}
		else if ( widgetConfig.subTitleSrc == "modelname" )
		{
			productSubTitle = data.ModelName;
		}
		else if ( widgetConfig.subTitleSrc == "empty" )
		{
			productSubTitle = "";
		}
		else
		{
        	var attrVal = getProductAttributeValue(data, widgetConfig.subTitleSrc);
        	if ( attrVal != '' ) productDescription = attrVal;
		}
	}

	// process attributes
	for (var x in data.Attributes) {
        var attribute = data.Attributes[x];

        //console.log('attribute lookup: ', attribute);

        if (x == "NAME_GROUP" ) {
			productLabels[model] = attribute;
        }

        if (x == "SIZE" ) {
			productSizes[model] = attribute;
        }
    }

    //console.log('dataVariants: ', data.Variants);

    if ( data.Variants.length > 0 )
    {
    	// process products
		for ( var p in data.Variants )
		{
			var product = data.Variants[p];

			//console.log('variant product: ' + p , product)

			if ( widgetConfig.plrssLookup == undefined || widgetConfig.plrssLookup == null || widgetConfig.plrssLookup == "modelname")
			{
				productModels[productModels.length] = product.ModelName;	
			}
			else if ( widgetConfig.plrssLookup == "modelcode" )
			{
				productModels[productModels.length] = product.ModelCode;
			}

			// Grab labels and sizes
			for (var x in data.Attributes) {
	            var attribute = data.Attributes[x];

	            if (attribute.name == "NAME_GROUP" ) {
					productLabels[product.ModelName] = attribute.value;
	            }

	            if (attribute.name == "SIZE" ) {
					productSizes[product.ModelName] = attribute.value;
	            }
	        }
		}	
    }

	if ( widgetConfig.modelNameTextFormat != undefined && widgetConfig.modelNameTextFormat != null )
	{
		var modelText = widgetConfig.modelNameTextFormat.replace("{wtb_model}", modelName);
		$('#local_model_name').html(modelText);

		productSubTitle = modelText;
	}
	
	if ( widgetConfig.producPageText != undefined && widgetConfig.producPageText != null )
	{
		var productUrl = "additionalInfo";
		var modelText = "<a href=" + productUrl + ">" + widgetConfig.producPageText + "</a>";
		$('#product_link').html(modelText);
		$('#local_product_link').html(modelText);
	}

	if ( widgetConfig.variantDropdown != undefined && widgetConfig.variantDropdown != null && 
		 widgetConfig.variantDropdown != "none" )
	{
		var validDropdown = false;

		var dropdownStr = '<select id="variantSelect" name="variantSelect">'; //onChange="updateModel"

		var optionBaseStr = '<option label="{ddLabel}" value="{ddValue}">{ddDesc}</option>';

		var descStr = data.Description;

		//console.log('descStr: ' + descStr + ' | ' + widgetConfig.dropdownSrc, data.Attributes);

		if ( widgetConfig.dropdownSrc != undefined && widgetConfig.dropdownSrc != null && widgetConfig.dropdownSrc != '' )
		{
            var attrVal = getProductAttributeValue(data, widgetConfig.dropdownSrc);
            if ( attrVal != '' ) descStr = attrVal;

            //console.log('descStr: ' + descStr + " | attrVal: " + attrVal);
		}

		var baseProduct = optionBaseStr.replace('{ddLabel}', descStr);
		baseProduct = baseProduct.replace('{ddDesc}', descStr);
		baseProduct = baseProduct.replace('{ddValue}', modelName);

		dropdownStr += baseProduct;

		for ( var p in data.Variants )
		{
			var product = data.Variants[p];

			//console.log("variant product: ", product);

			var selectStr = product.Description;

			if ( widgetConfig.dropdownSrc != undefined && widgetConfig.dropdownSrc != null && widgetConfig.dropdownSrc != '' )
			{
            	var attrVal = getProductAttributeValue(product, widgetConfig.dropdownSrc);

            	//console.log("attribute val (" + widgetConfig.dropdownSrc + "): " + attrVal);

            	if ( attrVal != '' ) selectStr = attrVal;
        	}

			if ( descStr != selectStr )
			{
				var productStr = optionBaseStr.replace('{ddLabel}', selectStr);
				productStr = productStr.replace('{ddDesc}', selectStr);
				productStr = productStr.replace('{ddValue}', product.ModelName);

				dropdownStr += productStr;

				validDropdown = true;
			}
		}

		dropdownStr += '</select>';

		if ( (widgetConfig.alwaysShowDropdown != undefined && widgetConfig.alwaysShowDropdown) || 
			 validDropdown && !variantDropdownLoaded )
		{	
			if ( widgetConfig.variantText != undefined && widgetConfig.variantText != "" )
			{
				dropdownStr = '<div class="variantText">' + widgetConfig.variantText + "</div> " + dropdownStr;
			}

			if ( widgetConfig.variantDropdown == "online" || widgetConfig.variantDropdown == "both" || 
					widgetConfig.variantDropdown == "swap" ) 
			{
				$('.product_dropdown').html(dropdownStr);
			}

			if ( widgetConfig.variantDropdown == "local" || widgetConfig.variantDropdown == "both" ) 
			{
				$('#local_product_dropdown').html(dropdownStr);
			}

			addDropdownHandlers();
			$('#variantSelect').show();
            if (widgetConfig.startTab = "local" && widgetConfig.variantDropdown == "swap")
            {
                $('#variantSelect').hide();
            }

            variantDropdownLoaded = true;
		}
	}

	if ( widgetConfig.hideProductLogo != undefined && widgetConfig.hideProductLogo != null && 
		 widgetConfig.hideProductLogo )
	{
		$('.product_logo').hide();
		$('#local_product_logo').hide();
	}
	else
	{
		if ( productImage == null || productImage == '') productImage =  "../config/"+profileId+"/"+profileId+"-logo.png";

		$('.product_logo').attr('src', productImage);
		$('#local_product_logo').attr('src', productImage);				
	}

	if ( widgetConfig.titlePrefix != undefined )
		productDescription = widgetConfig.titlePrefix + productDescription;

	if ( widgetConfig.titleSuffix != undefined )
		productDescription = productDescription + widgetConfig.titleSuffix;

	$('#product_description').html(productDescription);
	$('#local_product_description').html(productDescription);

	$('#product_subtitle').html(productSubTitle);

	//console.log("exiting processVariantData");
};

function getProductAttributeValue(product, attributeName)
{
	var attrVal = '';

	// process attributes
	for (var x in product.Attributes) {
        var attribute = product.Attributes[x];

        if (x == attributeName ) {
			attrVal = attribute;
        }
    }

    return attrVal;
}

//Directions 
function direction(dest,lat,lng){

	$('#direction').show();
	$('#results').hide();
	$('#DirectionPrint').show();
	$('#dest-direction').val(dest);


   $('#direction-form').submit(function() {
   
	var ori = $('#origin-direction').val();

	   map.setZoom(7);
	   var currentLatLng = new google.maps.LatLng(lat, lng);
	   map.setCenter(currentLatLng);
	   
		   var directionsRenderer = new google.maps.DirectionsRenderer();
		   directionsRenderer.setMap(map);    
		   directionsRenderer.setPanel(document.getElementById('direction'));
			
		   var directionsService = new google.maps.DirectionsService();
		   
		   /////////////////////
		   default_unit_system = google.maps.UnitSystem.METRIC;
		   if(current_unit=="km"){
		   default_unit_system = google.maps.UnitSystem.METRIC;
		   } else if(current_unit=="miles"){
		   default_unit_system = google.maps.UnitSystem.IMPERIAL;
		   }
		   /////////////////////
		   
		   var request = {
			 origin: ori, 
			 destination: dest,
			 travelMode: google.maps.DirectionsTravelMode.DRIVING,
			 unitSystem: default_unit_system
		   };
		   directionsService.route(request, function(response, status) {
			 if (status == google.maps.DirectionsStatus.OK) {
				$('#DirectionPrint').prop('disabled', false);
			   directionsRenderer.setDirections(response);
			 } else {
			   //alert('Error: ' + status);
			   $('#direction').append('<table width="100%"><tr><td>Direction not found. Please try again.</td></tr></table>');
			 }	
		   });
		   
	 $('#direction-form').nextAll().remove();
	 return false;
	 
   });
   $("#DirectionPrint").click(function () {
		   var divContents = $(".adp").html();
		   var printWindow = window.open('', '', 'height=auto,width=800,overflow: auto');
		   printWindow.document.write('<html><head><title>DIV Contents</title>');
		   printWindow.document.write('</head><body >');
		   printWindow.document.write(divContents);
		   printWindow.document.write('</body></html>');
		   printWindow.document.close();
		   printWindow.print();
	   });	

}

function directionBack(){
	$('#direction').hide();
	$('#DirectionPrint').prop('disabled', true);
	$('#DirectionPrint').hide();
	$('#results').show();
	resetDirection();
}

function resetDirection(){
   gmap_location_lookup($('#address').val(),$('input[name=distance]:radio:checked').val(),'');
	$('#direction').html('');
	$('#direction').html('<h2 class="title-bg" style="padding-bottom:10px !important; ">Directions</h2><form method="post" id="direction-form"><p><table><tr><td>'+ssf_origin+':</td><td><input id="origin-direction" name="origin-direction" class="orides-txt" type=text /></td></tr><tr><td>'+ssf_destination+':</td><td><input id="dest-direction" name="dest-direction" class="orides-txt" type=text readonly /></td></tr></table><div id="get-dir-button" class="get-dir-button"><input type=submit id="get-direction" class="btn" value="'+ssf_store_get_direction+'"><input type="button" id="DirectionPrint" class="btn btnPrint" disabled="disabled" style="margin-left:5px; display:none;" value="'+ssf_store_print+'"/> <a href="javascript:directionBack()">'+ssf_back_btn+'</a></div></p></form>');
   var origin_autocomplete = new google.maps.places.Autocomplete($("#origin-direction")[0], {});
}

function generateDirections () {

    var firstResult = $(".pac-container .pac-item:first").text();
    var searchInputBox = $(".start-input-box > input").val();

    var suggestion_selected = $(".pac-item-selected").length > 0;
    var selected_text = $(".pac-item-selected").text();


    var lookupAddress = firstResult;
    if ( !suggestion_selected && firstResult == "" ) lookupAddress = searchInputBox;
    if ( suggestion_selected ) lookupAddress = selected_text;


    place_changed();
    var geocoder = new google.maps.Geocoder();
    geocoder.geocode({"address": lookupAddress}, function (results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
            calculateAndDisplayRoute(results[0].geometry.location);
        }
    });
};

function calculateAndDisplayRoute (startLocation) {

    var startAddress = new google.maps.LatLng(startLocation.lat(), startLocation.lng());
    var destAddress = new google.maps.LatLng(directionsStore.Latitude, directionsStore.Longitude);

    directionsDisplay.setMap(map);

    directionsService.route({
      origin: startAddress,
      destination: destAddress,
      travelMode: 'DRIVING'
    }, function(response, status) {
      if (status === 'OK') {
        directionsUpdate = true;

        var directionsRoute = document.getElementById('directionRoute');

        directionsDisplay.setPanel(directionsRoute);
        directionsDisplay.setDirections(response);
/*
height: 306px;
    margin-bottom: 0px;
    margin-right: 0px;
    direction: ltr;
    max-height: none;
    overflow-y: scroll;
*/
        $('#directionRoute').css('height', '306px');
        $('#directionRoute').css('overflow-y', 'scroll');
  /*      directionsRoute.css('', '');
        directionsRoute.css('', '');
        directionsRoute.css('', '');
*/
      } else {
        window.alert('Directions request failed due to ' + status);
      }
    });
}

function createDirectionsURL (lon, lat){
	var directionsBase = 'https://www.google.com/maps/dir/'

	var dirURL = directionsBase + currPlace.replace(/ /g, '+') + "/'" + lat + "," + lon + "'";

	return dirURL;
}

//Tag Managers
function addExternalPixels () {
	var GTMScriptAddition = 
		"<!-- Google Tag Manager -->" +
		"<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':" + 
					"new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0]," +
					"j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=" +
					"'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);" +
				  "})(window,document,'script','dataLayer','{gtm_id}');</script>" +
		"<!-- End Google Tag Manager -->";

	var GTMNoScriptAddition = 
		"<!-- Google Tag Manager (noscript) -->" + 
		"<noscript>" + 
			"<iframe src='https://www.googletagmanager.com/ns.html?id={gtm_id}' height='0' width='0' style='display:none;visibility:hidden'></iframe>" + 
		"</noscript>" +
		"<!-- End Google Tag Manager (noscript) -->";

	var FacebookPixelAddition = 
		"<!-- Facebook Pixel Code -->" +
		"<script>" +
			"!function(f,b,e,v,n,t,s)" +
			"{if(f.fbq)return;n=f.fbq=function()" +
			"{n.callMethod? n.callMethod.apply(n,arguments):n.queue.push(arguments)};" +
			"if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';" +
			"n.queue=[];t=b.createElement(e);t.async=!0;" +
			"t.src=v;s=b.getElementsByTagName(e)[0];" +
			"s.parentNode.insertBefore(t,s)}(window, document,'script'," +
			"'https://connect.facebook.net/en_US/fbevents.js');" +
			"fbq('init', '{fb_id}');" +
			"fbq('track', 'PageView');" +
		"</script>" +
		"<noscript><img height='1' width='1' style='display:none'" +
			"src='https://www.facebook.com/tr?id={fb_id}&ev=PageView&noscript=1'" +
		"/></noscript>" +
		"<!-- End Facebook Pixel Code -->";

	if ( widgetConfig.GoogleTagManagerID != undefined && widgetConfig.GoogleTagManagerID != null && 
		 widgetConfig.GoogleTagManagerID != "" )
	{
		GTMScriptAddition = GTMScriptAddition.replace('{gtm_id}', widgetConfig.GoogleTagManagerID);
		GTMNoScriptAddition = GTMNoScriptAddition.replace('{gtm_id}', widgetConfig.GoogleTagManagerID);

		$("head").append(GTMScriptAddition);
		$("body").prepend(GTMNoScriptAddition);
	}

	if ( widgetConfig.FacebookPixelID != undefined && widgetConfig.FacebookPixelID != null && 
		 widgetConfig.FacebookPixelID != "" )
	{
		FacebookPixelAddition = FacebookPixelAddition.replace('{fb_id}', widgetConfig.FacebookPixelID);

		$("head").append(FacebookPixelAddition);
	}
}

//**UI Helpers
//Store Helpers - Phone, Hours, Directions
function formatPhoneNumber (num) {
	if ( num == null ) return "Not Available.";

    var str = num.toString();

    var matched = str.match(/\d+\.?\d*/g);

    if ( matched != null )
    {
        // 10 digit
        if (matched.length === 3) {
            return '(' + matched[0] + ') ' + matched[1] + '-' + matched[2];
            // 7 digit
        } else if (matched.length === 2) {
            return matched[0] + '-' + matched[1];
        }
        // no formatting attempted only found integers (i.e. 1234567890)
        else if (matched.length === 1) {
            // 10 digit
            if (matched[0].length === 10) {
                return '(' + matched[0].substr(0, 3) + ') ' + matched[0].substr(3, 3) + '-' + matched[0].substr(6);
            }
            // 7 digit
            if (matched[0].length === 7) {
                return matched[0].substr(0, 3) + '-' + matched[0].substr(3);
            }
        }
    }

    // Format failed, return number back
    return num;
};

function getTodaysHoursFromPCAT (hoursString, twelveHour, timeZone) {		

	var hoursText = '';
	var startHour = '';
    var startMinute = '';
    var endHour = '';
    var endMinute = '';

	if (timeZone == null ) timeZone = "America/New_York";

	timeZone = "America/New_York";

	if ( widgetConfig.dateDefaultTimezone != undefined && widgetConfig.dateDefaultTimezone != null )
		timeZone = widgetConfig.dateDefaultTimezone;

	//console.log("getTodaysHoursFromPCAT - CEdev : " + hoursString + "|" + twelveHour + "|" + timeZone);

	try 
	{		
		//console.log("getHours Timezone: " + Intl.DateTimeFormat().resolvedOptions().timeZone);

		if ( widgetConfig.dateUseTimezone != undefined && widgetConfig.dateUseTimezone != null && 
			 widgetConfig.dateUseTimezone )
			timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

		// If this has come back null, good chance that it's IE and can't handle this format 
		var storeDate = new Date();

		if (timeZone != null )
		storeDate = new Date(new Date().toLocaleString("en-US", {timeZone: timeZone}));

		var userDate = new Date().toLocaleString();

		//console.log("storeDate : ", storeDate);
		//console.log("userDate : ", userDate);

		if ( hoursString.indexOf(' ') != -1 )
		{
			var hoursSplit = hoursString.split(' ');

			var extractedHours = '';

			//console.log('timeFormat - hoursSplit: ', hoursSplit);

			for ( var i = 0; i < hoursSplit.length; i++)
			{
				var part = hoursSplit[i];

				//console.log('timeFormat - hoursSplit part: ', part);

				// find days sections
				if ( part.endsWith(':') )
				{
					var cleanedDay = part.split(':')[0];

					//console.log('timeFormat - cleanedDay|currDay: ' + cleanedDay + "|" + storeDate.getDay());

					if ( ''+cleanedDay === ''+storeDate.getDay() )
					{
						i++;
						var foundHours = hoursSplit[i];

						//console.log('timeFormat - foundHours: ' + foundHours);

						var todayDetails = foundHours.split(':');
					    var openHour = todayDetails[0];
					    var openMinute = todayDetails[1];
					    var closeHour = todayDetails[2];
					    var closeMinute = todayDetails[3].split(',')[0];

					    if ( hoursText != '' ) hoursText += ', '
					    hoursText += formatHoursText(twelveHour, openHour, openMinute, closeHour, closeMinute);

					    // update control variables
					    if ( startHour == '' ) startHour = openHour;
					    if ( startMinute == '' ) startMinute = openMinute;
					    endHour = closeHour;
					    endMinute = closeMinute;
					}
				}
			}
		}
		else
		{
			var allDays = hoursString.split(',');

			//console.log("getTodaysHoursFromPCAT allDays: ", allDays);

			var todaysStoreHours = allDays.filter(function(d) {
				//console.log("getting day value: " + d.charAt(0) + "|" + storeDate); 
				return (parseInt(d.charAt(0)) - 1) === storeDate.getDay();
			})[0];

			//console.log("todaysStoreHours: ", todaysStoreHours);

			if ( todaysStoreHours == undefined || todaysStoreHours == null ) return "";

			//console.log("getTodaysHoursFromPCAT todaysStoreHours: ", todaysStoreHours);
		 
			if((todaysStoreHours.indexOf("00:00:23:59") > -1) ||
				(todaysStoreHours.indexOf("12:00PM:11:59AM") > -1) ||
				(todaysStoreHours.indexOf("12:00AM:11:59PM") > -1)
			){ return "Open 24 Hours"}

			// Full hours details
		    var todayDetails = todaysStoreHours.split(':');
		    var openHour = todayDetails[1];
		    var openMinute = todayDetails[2];
		    var closeHour = todayDetails[3];
		    var closeMinute = todayDetails[4];

		    // update control variables
		    if ( startHour == '' ) startHour = openHour;
		    if ( startMinute == '' ) startMinute = openMinute;
		    endHour = closeHour;
		    endMinute = closeMinute;

		    hoursText = formatHoursText(twelveHour, openHour, openMinute, closeHour, closeMinute);
		}

		//console.log("Hours Text: " + hoursText);

		if ( widgetConfig.simpleTimeDisplay != undefined && widgetConfig.simpleTimeDisplay )
			return hoursText;

		// Check times for open and closed
		var openingTime = new Date(storeDate.getTime());  
		openingTime.setHours(startHour);	  
		openingTime.setMinutes(startMinute);	  
		openingTime.setSeconds(0);

		var closingTime = new Date(storeDate.getTime());
		closingTime.setHours(endHour);
		closingTime.setMinutes(endMinute);
		closingTime.setSeconds(0);

		var openingTimeCurrentTimeDiff = (storeDate.getTime() - openingTime.getTime()) / (1000 * 60 * 60);
		var closingTimeCurrentTimeDiff = (storeDate.getTime() - closingTime.getTime()) / (1000 * 60 * 60);     

		//console.log("getTodaysHoursFromPCAT times: " + openingTime + "|" + closingTime + "|" + storeDate + "|" + 
		//				openingTimeCurrentTimeDiff + "|" + closingTimeCurrentTimeDiff);		
		  
		//if ( closingTime < openingTime ) closingTimeCurrentTimeDiff 

		//if (endHour < startHour) console.log("getTodaysHoursFromPCAT: endHour is before startHour");

		if( ( openingTimeCurrentTimeDiff > 0 && closingTimeCurrentTimeDiff < 0 ) || 
		   ( openingTimeCurrentTimeDiff > 0 && closingTimeCurrentTimeDiff > 0 && (endHour < startHour) ) )
		{    
			if(closingTimeCurrentTimeDiff > -1 && !(endHour < startHour))
			{	
				var minutesUntilClosing = Math.round(Math.abs(closingTimeCurrentTimeDiff * 60));

				var closingSoon = "Closed: opening";
				if ( widgetConfig.hoursClosedSoonLabel != undefined && widgetConfig.hoursClosedSoonLabel != null ) 
					closingSoon = widgetConfig.hoursClosedSoonLabel;

				return closingSoon + " " + openingClosingTimeDisplay(todaysStoreHours.split(":")[3]); 
			}

			var timeResult = "Open";

			if ( widgetConfig.hoursOpenLabel != undefined && widgetConfig.hoursOpenLabel != null ) 
				timeResult = widgetConfig.hoursOpenLabel;

			if ( widgetConfig.dateShowHours != undefined && widgetConfig.dateShowHours != null && 
				 widgetConfig.dateShowHours )
			{
				timeResult += ": " + hoursText;
			}

			//console.log("getTodaysHoursFromPCAT: open return " + timeResult);

			return  timeResult;
		} 		
		else if ( (openingTimeCurrentTimeDiff > 0 && closingTimeCurrentTimeDiff < 0) == false )
		{    
			if(openingTimeCurrentTimeDiff > -1 && closingTimeCurrentTimeDiff < 0)
			{			
				var minutesUntilOpen = Math.round(Math.abs(openingTimeCurrentTimeDiff * 60));

				var openingSoon = "Closed: opening";
				if ( widgetConfig.hoursOpeningSoonLabel != undefined && widgetConfig.hoursOpeningSoonLabel != null ) 
					openingSoon = widgetConfig.hoursOpeningSoonLabel;

				return openingSoon + " " + openingClosingTimeDisplay(todaysStoreHours.split(":")[1]); 
			}

			var timeResult = "Closed";

			if ( widgetConfig.hoursClosedLabel != undefined && widgetConfig.hoursClosedLabel != null ) 
				timeResult = widgetConfig.hoursClosedLabel;

			if ( widgetConfig.dateShowHours != undefined && widgetConfig.dateShowHours != null &&
			 	 widgetConfig.dateShowHours )
			{
				timeResult += ": " + hoursText;
			}

			//console.log("getTodaysHoursFromPCAT: closed return " + timeResult);

			return timeResult;
		}

	} 
	catch (err) {
		console.log("getTodaysHoursFromPCAT: caught error: ", err);
	}

	//console.log("getTodaysHoursFromPCAT: return empty");

	return "";	
};

function formatHoursText(twelveHour, openHour, openMinute, closeHour, closeMinute)
{
	var hoursText = '';

    var openAmPm = '';
    var closeAmPm = '';

    if (twelveHour) {
        //Opening
        if (parseInt(openHour) < 12) {
            //AM opening.
            openAmPm = 'am';

            if (openHour === '0') {
                openHour = '12';
            }
        }
        else {
            //PM opening.
            openAmPm = 'pm';

            if (openHour != '12') {
                openHour = (parseInt(openHour) - 12).toString();
            }
        }

        //Closing
        if (parseInt(closeHour) < 12) {
            //AM closing.
            closeAmPm = 'am';

            if (closeHour === '0') {
                closeHour = '12';
            }
        }
        else {
            //PM closing.
            closeAmPm = 'pm';

            if (closeHour != '12') {
                closeHour = (parseInt(closeHour) - 12).toString();
            }
        }
    }

    var untilText = 'until';

    if ( widgetConfig.hoursUntilLabel != undefined && widgetConfig.hoursUntilLabel != null ) 
    	untilText = widgetConfig.hoursUntilLabel;

    hoursText = openHour + ':' + openMinute + openAmPm + ' ' + untilText + ' ' + closeHour + ':' + closeMinute + closeAmPm;

    return hoursText;
}

function openingClosingTimeDisplay (input) {
	var hour = parseInt(input.replace('0',''));
	if(hour == 0) {	return "at Midnight"; }
	else if(hour < 12) { return "at " + hour + "AM"; } 
	else if(hour == 12)	{ return "at Midday"; }
	else if(hour > 12) { return "at " + (hour - 12) + "PM";	}
	return "shortly"
};

String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.split(search).join(replacement);
};

function processLocalResults(data)
{
	console.log('processLocalResults: ' + widgetConfig.useLateMapView + '|' + placeChanged + '|' + mapLoaded);
//&& placeChanged 
	if ( ( !widgetConfig.useLateMapView ) && !mapLoaded ) 
	{
		console.log('adding localInstructions');

		$('.localList-loading').hide();
		if ( widgetConfig.localInstructions != undefined && widgetConfig.localInstructions != null && 
			 widgetConfig.localInstructions != '')
		{
			$('#localList').append('<div class="oosmessage">' + widgetConfig.localInstructions + '</div>');	
		}
		return;
	}

	CaProductId = data.LocalRetailerStores.CaProductId;
	var d = new Date();

	var number = 0;

	impressionEvent = {
        "EventType": 4,
        "AccountId": profileId,
        "WidgetImpressionGuid": widgetImpressionGuid,
        "UserTrackingGuid": userTrackingGuid,
        "ReferrerUrl": referrerUrl,
        "UserAgent": userAgent,
        "CreateDate": d.toISOString(),
        "Events": []
    };

    // remove loading animation
	$('.localList-loading').hide();
	$('#localList').show();

	if( data.LocalRetailerStores.length > 0 ) {

		if ( !widgetConfig.useLateMapView ) {
			// clear previous pins
			if ( markers.length > 0 ) deleteMarkers();

			var infowindow = new google.maps.InfoWindow({
				maxWidth: "400",
				content: '',
				pixelOffset: new google.maps.Size(0,0)
			});
		}
		
		if(data.OnDemandAvailabilityUrl!=null){
			ondemand = true;
		}

		if ( widgetConfig.useExternalLocalOrdering != undefined && widgetConfig.useExternalLocalOrdering != null && 
			 widgetConfig.useExternalLocalOrdering && 
	 		typeof orderLocalWTBResults === "function" )
		{
			//console.log("Calling orderLocalWTBResults");
			data.LocalRetailerStores = orderLocalWTBResults(data.LocalRetailerStores);
		}
			
		$i = 1;
		jQuery.each( data.LocalRetailerStores, function(k,v){
			var store = v;
			var distance = store.DistanceFromUserLocation;
			if ( distance != null ) distance = distance.toFixed(1);

			var availability = "";

			var storeImpression = {
				"LocalProductSearchGuid": null,
				"ProductId": model,
				"RetailerId": store.RetailerName,
				"RetailerType": null,
				"RetailerName":store.LocationName,
				"StoreId": store.SourceLocationId,
				"StorePostalCode": store.PostalCode,
				"StoreRange": currRange,
				"StoreLongitude": store.Longitude,
				"StoreLatitude": store.Latitude
			};
/*
			var storeImpression = {
				Address1
				Address2
				CampaignTag
				City
				CountryCode
				EventDateTimeUtc
				EventType
				"LocalProductSearchGuid": null,
				"ProductId": model,
				ProductIdType
				ProfileId
				ReferrerUrl
				RegionCode
				"RetailerId": store.RetailerName,
				"RetailerType": null,
				"RetailerName":store.LocationName,
				"StoreId": store.SourceLocationId,
				StoreName
				"StorePostalCode": store.PostalCode,
				"StoreRange": currRange,
				"StoreLongitude": store.Longitude,
				"StoreLatitude": store.Latitude
				UserAgent
				UserTrackingId
				WidgetImpressionId
				WidgetUrl
			};
*/
			impressionEvent.Events.push(storeImpression);

			/* stock data start */
			var availability = "";

			if ( data.OnDemandAvailabilityLink == null || store.Availability !=='CallForAvailability' ) {
				
				if ( store.Availability != null ) {
					switch(store.Availability.toLowerCase())
					{
						case "available": availability = "In Stock";break;
						case "unavailable": availability = "Out of Stock";break;
						case "notavailable": availability = "Out of Stock";break;
						case "assumeavailability": availability = "Assume Availability";break;
                        case "notfound": availability = "Call For Availability"; break;
                        case "callforavailability": availability = "Call For Availability"; break;
						default: availability = store.Availability ;break;
					}	
				}
				else
				{
					availability = "Call For Availability";
				}
			}
			else
			{
				availability = "loading";	
			}

			var stockType = "out-stock";

			if ( availability != null )
			{
				stockType = availability.toLowerCase().indexOf("out of stock") > -1 ? "out" : "in";
				stockType = stockType + "-stock";	
			}
			else
			{
				availability = "callforavailability";
			}

			// REFACTOR THIS
			var statusCircle = '<i class="material-icons">' +
									'check_circle' +
								'</i>';

			var statusInfo = '<i class="material-icons">' +
								'info' +
							 '</i>';

			var statusDirect = '<p id="status_direct" class="status" >' + 
									'{statusCircle}' +
									'{statusInfo}' +					
									'{wtb_stock}' +
								'</p>';

			//console.log("Checking availability: " + store.RetailerName + "|" + availability);

			if ( (availability.toLowerCase().indexOf('in stock') == -1) && 
				(availability.toLowerCase().indexOf('callforavailability') == -1 ) && 
				(availability.toLowerCase().indexOf('loading') == -1 ) )
			{
				//console.log("setting statusCircle to empty");
				statusCircle = '';
			}

			if ( availability.toLowerCase().indexOf('out of stock') == -1) 
			{
				statusInfo = '';
			}

			statusDirect = statusDirect.replaceAll('{statusCircle}', statusCircle);
			statusDirect = statusDirect.replaceAll('{statusInfo}', statusInfo);

			var statusOnDemand = '<div id="status_on_demand" class="status" >' + 
									'<div class="loader-small"></div>' +
									'<p style="display:none"></p>' +
								'</div>';

			if ( availability.indexOf('loading') == -1) 
			{
				//console.log('OnDemand availability is NOT loading');
				statusOnDemand = '';
			}
			else
			{
				//console.log('OnDemand availability is loading');
				statusDirect = '';
			}

			/*stock data end */
			/*
			var stockType = "out-stock";
			// REFACTOR THIS
			var statusDirect = '<p id="status_direct" class="status" >' + 
									'{statusCircle}' +
									'{statusInfo}' +					
									'{wtb_stock}' +
								'</p>';

			var statusOnDemand = '<div id="status_on_demand" class="status" >' + 
									'<div class="loader-small"></div>' +
									'<p style="display:none"></p>' +
								'</div>';			
			*/
			var phoneInfoMobile = '<p class="phone" >' + 
									'<a class="store-details-phone-text" href="tel:{wtb_phone}">' +
								 	'<i class="material-icons valign-center md-18">' +
										'local_phone' +
									'</i>' +
									'{wtb_formatted_phone}</a>' +
								   '</p>';

			var phoneInfoDesktop = '<div class="store-details-phone-text">' +
								 	'<i class="material-icons valign-center md-18">' +
										'local_phone' +
									'</i>' +
									'{wtb_formatted_phone}</div>';				

			var phoneInfo = phoneInfoDesktop;

			if ( isMobile ) phoneInfo = phoneInfoMobile;

			var buyOnlineStr = '<p class="buy">' +
								'<a target="_blank" href="{wtb_buyNowLink}">' +
									'{wtb_localBuyOnline}' +
								'</a>' +
							   '</p>';

			var buyNowLink = "";
			var onlinePrice = "";

			var localPromotionStr = '<p class="promo" data-toggle="tooltip" data-placement="top" title="{tooltipTxt}" >' +
										'Offer' +
							   		'</p>';

			if ( widgetConfig.showLocalPromotions != undefined && widgetConfig.showLocalPromotions != null && 
				 widgetConfig.showLocalPromotions )
			{
				// Check the expected variables
				if ( store.Promotions[0] != undefined && store.Promotions[0] != null && 
					 store.Promotions[0].PromotionMessage != undefined && store.Promotions[0].PromotionMessage != null )
				{
					localPromotionStr = localPromotionStr.replace('{tooltipTxt}', store.Promotions[0].PromotionMessage);
				}
				else
				{
					localPromotionStr = '';
				}
			}
			else
			{
				localPromotionStr = '';
			}

			if ( onlineData[store.RetailerName] != null )
			{
				buyNowLink = onlineData[store.RetailerName]["buyNow"];
				onlinePrice = onlineData[store.RetailerName]["price"];
				onlinePrice = widgetConfig.currencySymbol + "" + onlinePrice;
			}
			else if ( store.LocationUrl != undefined && store.LocationUrl != '' )
			{
				buyNowLink = store.LocationUrl;
			}
			else
			{
				buyOnlineStr = '';
			}

			buyOnlineLabel = '';
			if ( widgetConfig.localOnlineLabel != undefined && widgetConfig.localOnlineLabel != null)
				buyOnlineLabel = widgetConfig.localOnlineLabel;

			localData[store.RetailerName + "_" + store.StreetLine1] = store;

			if ( widgetConfig.widgetType == "BuyOnlineBuyLocalFullTab" && version != '2.0' )
			{
				buyLocalTemplate = buyLocalFullTemplate;
			}

			var retailerName = "";
			if ( store.RetailerName != undefined && store.RetailerName != null ) retailerName = store.RetailerDisplayName;

			if ( (widgetConfig.localTitle != undefined && widgetConfig.localTitle != null && 
				  widgetConfig.localTitle == "LocationName") || retailerName == "" )
			{
				retailerName = store.LocationName;
			}

			var directionsStr = createDirectionsURL(store.Longitude, store.Latitude);

			if ( widgetConfig.mapDirections != undefined && widgetConfig.mapDirections != null && 
				 widgetConfig.mapDirections )
			{
				directionsStr = '#';
			}

			if ( widgetConfig.directionsLabel == undefined && widgetConfig.directionsLabel == null ) 
				 widgetConfig.directionsLabel = 'Directions';
			
			var distanceUnits = 'mi';
			if ( widgetConfig.distanceUnits == "Kilometers" ) distanceUnits = 'km';

			var attributeClass = '';

			if ( store.Attributes.RetailerOrderingType != undefined ) 
			{
				attributeClass = store.Attributes.RetailerOrderingType;
				attributeClass = attributeClass.replaceAll(',', ' ');
			}

			var cleanStoreId = '';

			if ( store.SourceLocationId != null )
			{
				cleanStoreId = store.SourceLocationId.replaceAll('/', '');
				cleanStoreId = cleanStoreId.replaceAll('(', '');
				cleanStoreId = cleanStoreId.replaceAll(')', '');
				cleanStoreId = cleanStoreId.replaceAll(' ', '');
				cleanStoreId = cleanStoreId.replaceAll('.', '');
				cleanStoreId = cleanStoreId.replaceAll(',', '');
				cleanStoreId = cleanStoreId.replaceAll('\'', '');	
			}

			var cleanPhoneNumber = store.Phone.replaceAll(' ', '');

			var buyLocalResult = buyLocalTemplate.replaceAll('{wtb_retailerNameAndLocation}', store.RetailerId + "_" + cleanStoreId);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_attributeClass}', attributeClass);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_titleTrim}', store.RetailerDisplayName);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_retailerName}', retailerName);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_counter}', $i);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_logo}', store.RetailerLogoSquareUrl == '' ? store.RetailerLogoUrl : store.RetailerLogoSquareUrl );
			buyLocalResult = buyLocalResult.replaceAll('{wtb_streetline1}', store.StreetLine1);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_city}', store.City);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_state}', store.State);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_postcode}', store.PostalCode);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_phoneDisplay}', phoneInfo);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_phone}', cleanPhoneNumber);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_formatted_phone}', formatPhoneNumber(store.Phone));
			//buyLocalResult = buyLocalResult.replaceAll('{wtb_hours}', getTodaysHoursFromPCAT(store.Hours, show12Hour, null));
			var wtbStoreHours = getTodaysHoursFromPCAT(store.Hours, show12Hour, store.Timezone);

			//console.log("getTodaysHoursFromPCAT result: " + wtbStoreHours);

			buyLocalResult = buyLocalResult.replaceAll('{wtb_hours}', wtbStoreHours);

			buyLocalResult = buyLocalResult.replaceAll('{wtb_statusDirect}',  statusDirect);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_statusOnDemand}',  statusOnDemand);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_stockType}',  stockType);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_stock}', availability);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_directions}', directionsStr); // mapLinkToDirections(store.MapLink));
			buyLocalResult = buyLocalResult.replaceAll('{wtb_index}', $i);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_title}', retailerName);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_distance}', distance);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_distanceUnits}', distanceUnits);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_directionsLabel}', widgetConfig.directionsLabel);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_LocalPromotions}', localPromotionStr);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_BuyOnline}', buyOnlineStr);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_localBuyOnline}', buyOnlineLabel);
			buyLocalResult = buyLocalResult.replaceAll('{wtb_buyNowLink}', buyNowLink); // grab from plrss results
			buyLocalResult = buyLocalResult.replaceAll('{wtb_onlinePrice}', (onlinePrice != null && onlinePrice != "$null") ? onlinePrice : ''); // grab from plrss results

			if(store.ProductLink!=null){
				buyLocalResult = buyLocalResult.replaceAll('{wtb_clickandcollect}', "<a target='_blank' title='Click and collect' href='"+ store.ProductLink + "'>Click and Collect</a>");
			} else {
				buyLocalResult = buyLocalResult.replaceAll('{wtb_clickandcollect}', "");
			}

			// clean up address
			buyLocalResult = buyLocalResult.replaceAll(', , ', ', ');

			//storeLocalEntry (cleanStoreId+"-"+model, store, buyLocalResult, info_window_string, marker, cleanStoreId);

			var appendResult = true;

			if ( widgetConfig.useExternalLocalFiltering != undefined && widgetConfig.useExternalLocalFiltering != null && 
				 widgetConfig.useExternalLocalFiltering && typeof filterLocalWTBResults === "function" )
			{
				//console.log("Calling filterLocalWTBResults");
				appendResult = filterLocalWTBResults(store);
			}

			if ( appendResult )
			{
				$('#localList').append(buyLocalResult);

				if ( !widgetConfig.useLateMapView ) {
					var info_window_string = info_window_content(v);

					var marker = new google.maps.Marker({
						__gm_id: $i,
						position: new google.maps.LatLng(store.Latitude,store.Longitude),
						icon: {
							path:"M172.268 501.67C26.97 291.031 0 269.413 0 192 0 85.961 85.961 0 192 0s192 85.961 192 192c0 77.413-26.97 99.031-172.268 309.67-9.535 13.774-29.93 13.773-39.464 0z",
							fillColor: '#EA7824',
							fillOpacity: 1,
							strokeColor: '',
							strokeWeight: 0,
							scale: 0.06, //size of the marker, careful! this scale also affects anchor and labelOrigin
							anchor: new google.maps.Point(200,510), //position of the icon, careful! this is affected by scale
							labelOrigin: new google.maps.Point(205,190)//position of the label, careful! this is affected by scale
							
						},
						label: {
						    text: ""+$i,
						    color: "#fff",
						    fontSize: "14px",
						    fontWeight: "bold"
						}
					});

					// attach popup to click event
					google.maps.event.addListener(marker, 'click', function() {

						$('#localList .media').removeClass('active');
						$('#l_'+marker['__gm_id']).addClass('active');

						currentStore = store;
						
						var currentLatLng = new google.maps.LatLng(store.Latitude,store.Longitude);
						map.setCenter(currentLatLng);

						var clickedZoom = 16;
						if ( widgetConfig.clickedZoom != undefined && widgetConfig.clickedZoom != null ) clickedZoom = widgetConfig.clickedZoom;
						map.setZoom(clickedZoom);
						
						infowindow.setContent(info_window_string);
						infowindow.open(map, marker);

						console.log('InfoWindow Contents: ', $('.info-window .store-phone > a'));

						setTimeout(function(){
							$('.info-window .store-phone > a').click(function(event){
								currentStore = store;
								localStorePhoneCallClick();
							});

							$('.info-window .store-direction > a').click(function(event){
								currentStore = store;
								getDirectionsClick();
							});

							$('.info-window .store-phone a').css('color', '#21201F');
							$('.info-window .store-phone span').css('display', 'block');

						}, 150);
						
						if( trackEvents ){ postPetsEvent('LocalStoreClick'); }
					});	
					
					markers.push(marker);	

					$('#retailer_' + store.RetailerId + "_" + cleanStoreId).click(function(){

						currentStore = store;
						var currentLatLng = new google.maps.LatLng(store.Latitude, store.Longitude);
						map.setCenter(currentLatLng);
						map.setZoom(16);
						infowindow.setContent(info_window_string);
						infowindow.open(map, marker);
						
						if( trackEvents ){ postPetsEvent('LocalStoreClick'); }

						setTimeout(function(){
							$('.info-window .store-phone > a').click(function(event){
								currentStore = store;
								localStorePhoneCallClick();
							});

							$('.info-window .store-direction > a').click(function(event){
								currentStore = store;
								getDirectionsClick();
							});

							$('.info-window .store-phone a').css('color', '#21201F');
							$('.info-window .store-phone span').css('display', 'block');
						}, 150);
					});

					if ( widgetConfig.mapDirections != undefined && widgetConfig.mapDirections != null && 
						 widgetConfig.mapDirections )
					{
						var directionsLink = $('#retailer_' + store.RetailerId + "_" + cleanStoreId + " > div.options > #directionsButton > div");

						console.log('directionsLink: ', directionsLink);

						directionsLink.attr('target', '');

						directionsLink.click(function(){

							currentStore = store;

							console.log('directionsClick currentStore: ' + currentStore.StreetLine1);

							// Build store data
							var storeHtml = '<h3>' + retailerName + '</h3>';

							if ( currentStore.StreetLine1.trim() != '' ) 
								storeHtml += '<p>' + currentStore.StreetLine1 + ', ';

							if ( currentStore.City.trim() != '' ) 
								storeHtml += currentStore.City + ',';

							if ( currentStore.State.trim() != '' ) 
								storeHtml += currentStore.State + '</p>';

							$('#directionsStore').html(storeHtml);

							directionsStore = store;

							// Update Display
							$('#directionsSelect').hide();
							$('#directionsLocations').show();

							$('#retailer_' + currentStore.RetailerId + "_" + cleanStoreId).click();
							$( "#directions-tab" ).click();

							console.log("Calling directionsClick()");

							getDirectionsClick();
							return false;
						})
					}
					else
					{
						$('#retailer_' + store.RetailerId + '_' + cleanStoreId + '> div.details > p.directions > a').unbind().click(function(event){
							currentStore = store;
							getDirectionsClick();
						});
					}

					$('#retailer_' + store.RetailerId + '_' + cleanStoreId + '> div.details > p.phone > a').unbind().click(function(event){
						currentStore = store;
						localStorePhoneCallClick();
					});
				} else {
					//updateDisplayForLateMapView();
				}

				$i++;
				number++;			
			}

		} ); 

		if ( number == 0 )
		{
			console.log('number is 0, set oosmessage');
			$('#localList').append('<div class="oosmessage">' + widgetConfig.noLocalStock + '</div>');	
		}
		else
		{
			if ( !widgetConfig.useLateMapView ) {

				//Zoom to markers
				var bounds = new google.maps.LatLngBounds();
				for (var i = 0; i < markers.length; i++) {
					bounds.extend(markers[i].getPosition());
				}
				map.fitBounds(bounds);	
				
				if ( number == 1 )
				{
					map.setZoom(15);
				}
				
				
				markerCluster = new MarkerClusterer(map, markers, {
					maxZoom: 16,
					imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
				});
			}	
		}
		
	} else {
		if ( initialSearch )
		{
			$('#localList').append('<div class="oosmessage">' + widgetConfig.localInstructions + '</div>');
		}
		else
		{
			$('#localList').append('<div class="oosmessage">' + widgetConfig.noLocalStock + '</div>');	
		}
	}

	if( trackEvents ){ postPetsEvent('LocalStoreImpression'); }

	if( data.OnDemandAvailabilityLink != null )
	{					
		onDemandAvailabilityUrl = data.OnDemandAvailabilityLink;
		onDemandAvailabilityUrl = onDemandAvailabilityUrl.replace('http:', 'https:');
		availability = "loading";	
		GetOnDemandAvailability();	
	}		

    $('[data-toggle="tooltip"]').tooltip();		

	inProgress = false;

	$(document).trigger("WTBLocalLoaded");
}

function updateDisplayForLateMapView() {

	console.log('Reached updateDisplayForLateMapView');

	$('.wtb-local').show();

	if ( typeof updateDisplayForMapless === "function")
	{
		setTimeout(updateDisplayForMapless(), 100);
	}

	if ( !mapLoaded ) {
		$('#map').hide();
	}

	$('#viewMap').unbind();
	$('#viewMap').click(function(){

		console.log('Caught viewMap click');

		if ( !mapLoaded ) {
			initMap();
		}

		revertDisplayForLateMapView();
	});
}

function revertDisplayForLateMapView() {

	if ( typeof revertDisplayForMapless === "function")
	{
		revertDisplayForMapless();
	}

	$('#map').show();
	
	$('#viewMap').unbind();
	$('#viewMap').click(function(){

		updateDisplayForLateMapView();
	});
}

function GetOnDemandAvailability()
{
	setTimeout(function(){	

	    var authToken = widgetConfig.authToken;

	    if ( widgetConfig.WTBAuthToken != undefined && widgetConfig.WTBAuthToken != null )
	    	authToken = widgetConfig.WTBAuthToken;

		var rtaUrl = onDemandAvailabilityUrl;

		$.ajax({
			url: rtaUrl,
			type: 'GET',
			beforeSend: function (xhr) {
	        	/* Authorization header */
		        xhr.setRequestHeader("Authorization", 'api-key ' + authToken);
	    	},
			success: function (data) {

				jQuery.each( data.BuyLocalAvailabilitiesPerRetailer, function(k,v){								
								
						var retailerId = v.RetailerId;
						for( var i in v.BuyLocalAvailabilities ) 
						{
							var location = v.BuyLocalAvailabilities[i];

							if( location.AvailabilityStatus != ODCallForAvailability || 
								data.JobStatus != ODSProcessing ){
								UpdateStatus(retailerId, location);	
							}																		
						}	
                });

				if( data.JobStatus == ODSProcessing ) {
					GetOnDemandAvailability();
				}
			}
		});
	}, 2000)
};	

function UpdateStatus (retailerId, location) {

	var locationId = location.SourceLocationId;
	var el = '#' + retailerId + "_" + locationId + "_stock";
	var elStatusP = el + ' #status_on_demand p';	
	
	if($(elStatusP).text().length > 0){ return; }
	
	
	var elStatusLoaderSmall = el + ' #status_on_demand .loader-small';
	
	$(elStatusLoaderSmall).hide();
	if(location.AvailabilityStatus == ODUnavailable || location.AvailabilityStatus == ODNotFound){	

		$(el).removeClass("in-stock").addClass("out-stock");
		$(elStatusP).text("Out of stock").hide().fadeIn();
		$('#status_on_demand').removeClass("in-stock").addClass("out-of-stock");

	} else if(location.AvailabilityStatus == ODAvailable || location.AvailabilityStatus == ODAssumeAvailability){	

		$(el).removeClass("out-stock").addClass("in-stock");
		$(elStatusP).text("In stock").hide().fadeIn();
		$('#status_on_demand').removeClass("out-of-stock").addClass("in-stock");

	} else if(location.AvailabilityStatus == ODCallForAvailability){
		var infoText ="Call For Availability";		
		$(elStatusP).text(infoText).hide().fadeIn();
		$('#status_on_demand').removeClass("out-of-stock").removeClass("in-stock").addClass("call-stock");
	}
};

function storeLocalEntry (name, currStore, buyLocalEntry, infowindowContent, marker, cleanStoreId) 
{
	localResults[name] = {};
	localResults[name]["store"] = currStore;
	localResults[name]["resultEntry"] = buyLocalEntry;
	localResults[name]["infowindowContent"] = infowindowContent;
	localResults[name]["marker"] = marker;
	localResults[name]["cleanStoreId"] = cleanStoreId;
}

function sort_distance(){

    var numbersort = 1;
	var items = $('#localList li').get();
	
	items.sort(function(a,b){ 
	 
	  var keyA = $(a).find('#disval').text();
	  var keyB = $(b).find('#disval').text();
	  
	  if ((Math.round(parseFloat(keyA)*100)/100) < (Math.round(parseFloat(keyB)*100)/100)) { return -1; }
	  if ((Math.round(parseFloat(keyA)*100)/100) > (Math.round(parseFloat(keyB)*100)/100)) { return 1; }
	  
	  return 0;
	});	
	
	var ol = $('#localList');
	$.each(items, function(i, li){
	  ol.append(li);
	  $('#'+$(li).attr('id')+' .number').text(numbersort);
	  numbersort++;
	});

}

function callback(response, status) {
    
  if (status == google.maps.DistanceMatrixStatus.OK) {
    var origins = response.originAddresses;
    var destinations = response.destinationAddresses;


    for (var i = 0; i < origins.length; i++) {
      var results = response.rows[i].elements;

      for (var j = 0; j < results.length; j++) {
	  
        var element = results[j];

          var distance = element.distance.value;

	  distance /= 1000;  // conv to km

	  var un = '';
	  if(current_unit=='miles') {
	      distance= parseFloat(Math.round(distance * km2mile *100)/100);
	      un = themiles;
	  }	      
	  else {
 	      distance= parseFloat(Math.round(distance*100)/100);   
	      un = thekm;
	  }

        var duration = element.duration.text;
        var from = origins[i];
        var to = destinations[j];

		arr.push(distance);

      }
    }
	distancecode++;

	if(distancecode==(totalrec+1)){
		distancecode=0;
		arr.sort(function(a,b){return a-b});
		
		for(k=0;k<=arr.length;k++){
			$('#d_'+(k+1)+' .value').html(arr[k]);
			$('#d_'+(k+1)+' .units').html(un);
		}
		arr = [];
	}
  } 
}
  
function info_window_content(v) {

	var directionsURL = createDirectionsURL(v.Longitude, v.Latitude);

	var info_window_string = "<div class='info-window'>";

	var logoUrl = v.RetailerLogoSquareUrl;

	if(v.RetailerLogoSquareUrl == '') {	
		logoUrl = v.RetailerLogoUrl;
	}

	var retailerName = v.RetailerName;

	if ( (widgetConfig.localTitle != undefined && widgetConfig.localTitle != null && 
		  widgetConfig.localTitle == "LocationName") || retailerName == undefined || retailerName == "" )
	{
		retailerName = v.LocationName;
	}
	
	//console.log('info_window: ' + logoUrl);

	if ( logoUrl != undefined && logoUrl != null && logoUrl != '' ) 
	{
		info_window_string += "<img class='store-logo' src='" + logoUrl + "' alt='" + retailerName + "' />";	
	}
	info_window_string += "<h3 class='store-title'>" + retailerName + "</h3>";


	var splitaddress = "";

	var locationAddress = '';

	if ( v.StreetLine1.trim() != '' ) 
		locationAddress += v.StreetLine1 + ', ';

	if ( v.City.trim() != '' ) 
		locationAddress += v.City + ', ';

	if ( v.State.trim() != '' ) 
		locationAddress += v.State + ', ';


	if ( v.PostalCode.trim() != '' ) 
		locationAddress += v.PostalCode;

	splitaddress += locationAddress;

	info_window_string += "<p class='store-address'>"+splitaddress+"</p>";

	var hoursText = "Hours:";
	var phoneText = "Telephone:";
	var directionText = "Directions:";

	if ( widgetConfig.hoursLabel != undefined && widgetConfig.hoursLabel != null ) 
		hoursText = widgetConfig.hoursLabel;

	if ( widgetConfig.phoneLabel != undefined && widgetConfig.phoneLabel != null ) 
		phoneText = widgetConfig.phoneLabel;

	if ( widgetConfig.directionsLabel != undefined && widgetConfig.directionsLabel != null ) 
		directionText = widgetConfig.directionsLabel;

	var cleanPhoneNumber = v.Phone.replaceAll(' ', '');

    info_window_string += '<p class="store-hours"><span>'+hoursText+'</span> ' + getTodaysHoursFromPCAT(v.Hours, show12Hour, null) + '</p>';
    info_window_string += '<p class="store-phone"><a href="tel:'+v.Phone+'" target="_blank"><span class="phone-text">' + phoneText + '</span> <span>' + formatPhoneNumber(v.Phone) + '</span></a></p>';
    info_window_string += '<p class="store-direction"><a href="'+ directionsURL +'" target="_blank"><span>'+directionText+'</span></a></p>';

	info_window_string += "</div>";

	return info_window_string;
	
}

getDirectionsClick = function () {
	if( trackEvents ){ 
		console.log("Firing event: getDirectionsClick"); 
		postPetsEvent('LocalStoreGetDirectionsClick'); 
	}
};

localStorePhoneCallClick = function () {
	if( trackEvents ){
		console.log("Firing event: localStorePhoneCallClick"); 
		postPetsEvent('LocalStorePhoneCallClick'); 
	}
}

function postPetsEvent (type, event) {

	console.log('postPetsEvent - type: ' +  type);

    switch (type) {
        case 'WidgetImpression':
            petsPostWidgetImpression({
                accId: profileId,
                referrerUrl: referrerUrl,
                userAgent: userAgent,
                postCode: postCode,
                geo: geo,
                model: model,
                distance: currRange,
                tag: tag
            });
            break;
        case 'ProductImpression':
            petsPostProductImpression({
                accId: profileId,
                widgetImpressionGuid: widgetImpressionGuid,
                referrerUrl: referrerUrl,
                userAgent: userAgent,
                postCode: postCode,
                geo: geo,
                model: model,
                distance: currRange,
                tag: tag
            });
            break;
        case 'LocalSearch':
            petsPostLocalSearchEvent({
                accId: profileId,
                widgetImpressionGuid: widgetImpressionGuid,
                referrerUrl: referrerUrl,
                userAgent: userAgent,
                postCode: postCode,
                geo: geo,
                model: model,
                distance: currRange,
                tag: tag
            });
            break;
        case 'LocalStoreImpression':
            petsPostLocalStoreImpressionEvent({
                accId: profileId,
                widgetImpressionGuid: widgetImpressionGuid,
                tag: tag
            }, impressionEvent);
            break;
        case 'LocalStoreClick':
            var query = petsPostLocalStoreClickEvent({
                accId: profileId,
                widgetImpressionGuid: widgetImpressionGuid,
                referrerUrl: referrerUrl,
                userAgent: userAgent,
                postCode: postCode,
                geo: geo,
                model: model,
                distance: currRange,
                tag: tag
            }, currentStore, 0);
            break;
        case 'LocalStorePhoneCallClick':        
            var query = petsPostLocalStoreClickEvent({
                accId: profileId,
                widgetImpressionGuid: widgetImpressionGuid,
                referrerUrl: referrerUrl,
                userAgent: userAgent,
                postCode: postCode,
                geo: geo,
                model: model,
                distance: currRange,
                tag: tag
            }, currentStore, 1);
            break;
        case 'LocalStoreGetDirectionsClick':
            var query = petsPostLocalStoreClickEvent({
                accId: profileId,
                widgetImpressionGuid: widgetImpressionGuid,
                referrerUrl: referrerUrl,
                userAgent: userAgent,
                postCode: postCode,
                geo: geo,
                model: model,
                distance: currRange,
                tag: tag
            }, currentStore, 2);
            break;
    }
}

function petsPostWidgetImpression (params) {
	var oauth = petsOAuth.replace("{0}", profileId);

	$.ajax({
		url: oauth,
		type: 'GET',
		success: function (data) { 
            var d = new Date();
            var n = d.toISOString();
            var event = {
                "EventType": 1,
                "AccountId": params.accId,
                "ReferrerUrl": params.referrerUrl,
                "UserAgent": params.userAgent,
                "CreateDate": n,
                "Events": [
                {
                     "CampaignTag": params.tag,
                     "PageImpressionGuid": null,
                     "ProductId": params.model,
                     "UserSearchPostalCode": params.postCode,
                     "UserSearchRange": params.distance,
                     "UserSearchLongitude": params.lng,
                     "UserSearchLatitude": params.lat
                }]
            }

            if ( data != null )
            {
				$.ajax({
					url: petsCall,
					type: 'POST',
	                data: event,
					beforeSend: function (xhr) {
						xhr.setRequestHeader('Authorization', 'bearer '+ data.AccessToken);
					},
					success: function (data) { 

	                	userTrackingGuid = data.TrackingGuid;
	                	widgetImpressionGuid = data.WidgetImpressionGuid;
	                	if(trackEvents){postPetsEvent('ProductImpression');}
					}
				});
            }
		}
	});
};

function petsPostProductImpression (params) {

	var oauth = petsOAuth.replace("{0}", profileId);

	$.ajax({
		url: oauth,
		type: 'GET',
		success: function (data) { 
            var d = new Date();
            var n = d.toISOString();
		    var event = {
		        "EventType": 2,
		        "AccountId": params.accId,
		        "WidgetImpressionGuid": params.widgetImpressionGuid,
		        "UserTrackingGuid": params.userTrackingGuid,
		        "ReferrerUrl": params.referrerUrl,
		        "UserAgent": params.userAgent,
		        "CreateDate": n,
		        "Events": [
		          {
		              "CampaignTag": params.tag,
		              "PageImpressionGuid": params.pageImpressionGuid,
		              "ProductId": params.model,
		              "UserSearchPostalCode": params.postCode,
		              "UserSearchRange": params.distance,
		              "UserSearchLongitude": params.lng,
		              "UserSearchLatitude": params.lat
		          }
		        ]
		    }

            if ( data != null )
            {
				$.ajax({
					url: petsCall,
					type: 'POST',
	                data: event,
					beforeSend: function (xhr) {
						xhr.setRequestHeader('Authorization', 'bearer '+ data.AccessToken);
					},
					success: function (data) { 
						//console.log("postProductImpression result: ", data);
					}
				});
			}
		}
	});
};

function petsPostLocalSearchEvent (params){

	var oauth = petsOAuth.replace("{0}", profileId);

	$.ajax({
		url: oauth,
		type: 'GET',
		success: function (data) { 

	        var d = new Date();
	        var n = d.toISOString();

	        var event = {
	            "EventType": 3,
	            "AccountId": params.accId,
	            "WidgetImpressionGuid": params.widgetImpressionGuid,
	            "UserTrackingGuid": params.userTrackingGuid,
	            "ReferrerUrl": params.referrerUrl,
	            "UserAgent": params.userAgent,
	            "CreateDate": n,
	            "Events": [
	             {
	                 "CampaignTag": params.tag,
	                 "ProductId": params.model,
	                 "UserSearchPostalCode": params.postCode,
	                 "UserSearchRange": params.distance,
	                 "UserSearchLongitude": params.lng,
	                 "UserSearchLatitude": params.lat
	             }
	            ]
	        };

            if ( data != null )
            {
				$.ajax({
					url: petsCall,
					type: 'POST',
	                data: event,
					beforeSend: function (xhr) {
						xhr.setRequestHeader('Authorization', 'bearer '+ data.AccessToken);
					},
					success: function (data) { 
						//console.log("petsPostLocalSearchEvent result: ", data);
					}
				});
			}
		}
	});
};

function petsPostLocalStoreImpressionEvent (params, event){

	var oauth = petsOAuth.replace("{0}", profileId);

	$.ajax({
		url: oauth,
		type: 'GET',
		success: function (data) { 

            if ( data != null )
            {
				$.ajax({
					url: petsCall,
					type: 'POST',
	                data: event,
					beforeSend: function (xhr) {
						xhr.setRequestHeader('Authorization', 'bearer '+ data.AccessToken);
					},
					success: function (data) { 
						//console.log("petsPostLocalStoreImpressionEvent result: ", data);
					}
				});
			}
		}
	});
};

function petsPostLocalStoreClickEvent (params, store, actionType){

	var oauth = petsOAuth.replace("{0}", profileId);

	$.ajax({
		url: oauth,
		type: 'GET',
		success: function (data) { 

	        var d = new Date();
	        var n = d.toISOString();  

	        var retailerName = currentStore.RetailerName;

			if ( ( widgetConfig.localTitle != undefined && widgetConfig.localTitle != null && 
				   widgetConfig.localTitle == "LocationName") || retailerName == "" )
			{
				retailerName = currentStore.LocationName;
			}      

	        var event = {
	            "EventType": 5,
	            "AccountId": params.accId,
	            "WidgetImpressionGuid": params.widgetImpressionGuid,
	            "UserTrackingGuid": params.userTrackingGuid,
	            "ReferrerUrl": params.referrerUrl,
	            "UserAgent": params.userAgent,
	            "CreateDate": n,
	            "Events": [
	              {
	                  "CampaignTag": params.tag,
	                  "ProductId": params.model,
	                  "LocalProductSearchGuid": params.localProductSearchGuid,
	                  "RetailerIdGuid": currentStore.RetailerId,
	                  "RetailerName": retailerName,
	                  "StoreIdGuid": currentStore.SourceLocationId,
	                  "StoreAddressLine1": currentStore.StreetLine1,
	                  "StoreAddressLine2": currentStore.StreetLine2,
	                  "StoreCity": currentStore.City,
	                  "StoreRegionCode": currentStore.State,
	                  "StoreCountryCode": currentStore.countryCode,
	                  "StoreRange": currentStore.DistanceFromUserLocation,
	                  "StorePostalCode": currentStore.PostalCode,
	                  "StoreLatitude": currentStore.Latitude,
	                  "StoreLongitude": currentStore.Longitude,
	                  "RetailerType": null,
	                  "OfferPrice": "",
	                  "CurrencyCode": "",
	                  "InStock": currentStore.Availability,
	                  "UserSearchPostalCode": params.postCode,
	                  "UserSearchRange": params.distance,
	                  "UserSearchLongitude": params.lng,
	                  "UserSearchLatitude": params.lat
					  
	              }
	            ]
	        };

	        console.log('petsPostLocalStoreClickEvent - setting actionType: ' + actionType);

			if(actionType == 1){event.Events[0].ActionType = 1;}
			if(actionType == 2){event.Events[0].ActionType = 2;}

            if ( data != null )
            {
				$.ajax({
					url: petsCall,
					type: 'POST',
	                data: event,
					beforeSend: function (xhr) {
						xhr.setRequestHeader('Authorization', 'bearer '+ data.AccessToken);
					},
					success: function (data) { 
						//console.log("petsPostLocalStoreClickEvent result: ", data);
					}
				});
			}
		}
	});
};
